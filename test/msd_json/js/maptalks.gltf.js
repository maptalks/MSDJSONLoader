/*!
 * @maptalks/gltf-layer v0.30.1
 * LICENSE : UNLICENSED
 * (c) 2016-2022 maptalks.org
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("maptalks"),require("@maptalks/gl")):"function"==typeof define&&define.amd?define(["maptalks","@maptalks/gl"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).maptalks,t.maptalksgl)}(this,(function(t,e){"use strict";let i;function n(n,s){if(s||(s=n),i){s("object"==typeof exports&&"undefined"!=typeof module?module.exports:t,t,e)}else{if(e.transcoders){const i=e.transcoders.inject(s);t.registerWorkerAdapter("@maptalks/gltf-layer",i)}else t.registerWorkerAdapter("@maptalks/gltf-layer",s);i=!0}}function s(t){if(t&&t.t)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(i){if("default"!==i){var n=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,n.get?n:{enumerable:!0,get:function(){return t[i]}})}})),e.default=t,Object.freeze(e)}var r=s(t),o=s(e);n(["exports"],(function(t){var e="undefined"!=typeof Float32Array?Float32Array:Array;function i(t,e,i){var n=e[0],s=e[1],r=e[2],o=e[3],h=e[4],a=e[5],u=e[6],c=e[7],l=e[8],f=e[9],d=e[10],m=e[11],p=e[12],g=e[13],_=e[14],y=e[15],v=i[0],b=i[1],w=i[2],x=i[3];return t[0]=v*n+b*h+w*l+x*p,t[1]=v*s+b*a+w*f+x*g,t[2]=v*r+b*u+w*d+x*_,t[3]=v*o+b*c+w*m+x*y,v=i[4],b=i[5],w=i[6],x=i[7],t[4]=v*n+b*h+w*l+x*p,t[5]=v*s+b*a+w*f+x*g,t[6]=v*r+b*u+w*d+x*_,t[7]=v*o+b*c+w*m+x*y,v=i[8],b=i[9],w=i[10],x=i[11],t[8]=v*n+b*h+w*l+x*p,t[9]=v*s+b*a+w*f+x*g,t[10]=v*r+b*u+w*d+x*_,t[11]=v*o+b*c+w*m+x*y,v=i[12],b=i[13],w=i[14],x=i[15],t[12]=v*n+b*h+w*l+x*p,t[13]=v*s+b*a+w*f+x*g,t[14]=v*r+b*u+w*d+x*_,t[15]=v*o+b*c+w*m+x*y,t}function n(){var t=new e(3);return e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function s(t,i,n){var s=new e(3);return s[0]=t,s[1]=i,s[2]=n,s}function r(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function o(t,e,i,n){return t[0]=e,t[1]=i,t[2]=n,t}function h(t,e,i,n,s){return t[0]=e,t[1]=i,t[2]=n,t[3]=s,t}function a(){var t=new e(4);return e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function u(t,e,i,n){var s=e[0],r=e[1],o=e[2],h=e[3],a=i[0],u=i[1],c=i[2],l=i[3],f=void 0,d=void 0,m=void 0,p=void 0,g=void 0;return(d=s*a+r*u+o*c+h*l)<0&&(d=-d,a=-a,u=-u,c=-c,l=-l),1-d>1e-6?(f=Math.acos(d),m=Math.sin(f),p=Math.sin((1-n)*f)/m,g=Math.sin(n*f)/m):(p=1-n,g=n),t[0]=p*s+g*a,t[1]=p*r+g*u,t[2]=p*o+g*c,t[3]=p*h+g*l,t}n(),function(){var t,i=(t=new e(4),e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var c,l=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t};n(),s(1,0,0),s(0,1,0),a(),a(),c=new e(9),e!=Float32Array&&(c[1]=0,c[2]=0,c[3]=0,c[5]=0,c[6]=0,c[7]=0),c[0]=1,c[4]=1,c[8]=1;
/*!
     * @maptalks/gltf-loader v0.23.0
     * LICENSE : UNLICENSED
     * (c) 2016-2022 maptalks.org
     */
let f=0;function d(t){return null==t}function m(t){return!d(t)}function p(t){for(let e=1;e<arguments.length;e++){const i=arguments[e];for(const e in i)t[e]=i[e]}return t}function g(t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array}throw new Error("unsupported bufferView's component type: "+t)}function _(t){return 0===t.indexOf("data:")&&t.indexOf("base64,")>0}function y(t){const e=function(t){return"undefined"!=typeof self?self.atob(t):window.atob(t)}(t.substring(t.indexOf(",")+1)),i=e.length,n=new Uint8Array(i);for(let t=0;t<i;t++)n[t]=e.charCodeAt(t);return n.buffer}const v=[],b=[],w=[],x=[0,0,0],S=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}([]),M=[1,1,1];function O(t,e,i,n,s,r,o){const h=g(o);if((0===s||s===n*h.BYTES_PER_ELEMENT)&&r%h.BYTES_PER_ELEMENT==0){const s=new h(e,r,i*n);return t.set(s),t}const a=new Uint8Array(n*h.BYTES_PER_ELEMENT);for(let o=0;o<i;o++){let i=null;const u=new Uint8Array(e,s*o+r,n*h.BYTES_PER_ELEMENT);a.set(u),i=new h(a.buffer,0,n);for(let e=0;e<n;e++)t[o*n+e]=i[e]}return t}const T="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;function A(t,e,i){const n=new Uint8Array(t,e,i);return T.decode(n)}const P={get:function(t,e={}){e||(e={});const i=new AbortController,n={signal:i.signal,method:e.method||"GET",referrerPolicy:"origin"};"POST"===e.method&&(d(e.body)||(n.body=JSON.stringify(e.body))),d(e.headers)||(n.headers=e.headers),d(e.credentials)||(n.credentials=e.credentials);const s=fetch(t,n).then((t=>{const i=this.i(t,e.responseType);return i.message?i:i.then((i=>"arraybuffer"===e.responseType?{data:i,cacheControl:t.headers.get("Cache-Control"),expires:t.headers.get("Expires"),contentType:t.headers.get("Content-Type")}:i)).catch((t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t}))})).catch((t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t}));return s.xhr=i,s},i:(t,e)=>200!==t.status?{status:t.status,statusText:t.statusText,message:`incorrect http request with status code(${t.status}): ${t.statusText}`}:"arraybuffer"===e?t.arrayBuffer():"json"===e?t.json():t.text(),getArrayBuffer:(t,e={})=>(e||(e={}),e.responseType="arraybuffer",P.get(t,e)),getJSON:function(t,e={}){return e&&e.jsonp?P.jsonp(t):((e=e||{}).responseType="json",P.get(t,e))},jsonp:function(t){const e="_maptalks_jsonp_"+f++;t.match(/\?/)?t+="&callback="+e:t+="?callback="+e;let i=document.createElement("script");return i.type="text/javascript",i.src=t,new Promise((t=>{window[e]=function(n){document.getElementsByTagName("head")[0].removeChild(i),i=null,delete window[e],t(n)},document.getElementsByTagName("head")[0].appendChild(i)}))}},k=["SCALAR",1,"VEC2",2,"VEC3",3,"VEC4",4,"MAT2",4,"MAT3",9,"MAT4",16];class I{constructor(t,e,i){this.rootPath=t,this.gltf=e,this.o=!1,this.glbBuffer=i,this.buffers={},this.requests={},this.accessors={},this.h()}u(t,e){const i=this.gltf,n=i.accessors[e];if(void 0===n.bufferView)return this.accessors[n.id]=this.l(t,e,null,0),Promise.resolve(this.accessors[n.id]);if(n&&this.accessors[n.id])return Promise.resolve(this.accessors[n.id]);const s=i.bufferViews[n.bufferView];return this.m(s).then((i=>{const{buffer:s,byteOffset:r}=i;return this.accessors[n.id]=this.l(t,e,s,r)}))}m(t){const e=this.gltf.buffers[t.buffer];if(this.buffers[e.id]){const t=this.buffers[e.id];return Promise.resolve({buffer:t,byteOffset:0})}if(this.requests[e.id])return this.requests[e.id].then((()=>{const t=this.buffers[e.id];return Promise.resolve({buffer:t,byteOffset:0})}));if("binary_glTF"!==t.buffer&&"KHR_binary_glTF"!==t.buffer&&e.uri){if(_(e.uri)){const t=this.buffers[e.id]=y(e.uri);return Promise.resolve({buffer:t,byteOffset:0})}const t=this.rootPath+"/"+e.uri;return this.requests[e.id]=P.getArrayBuffer(t,null).then((t=>({buffer:this.buffers[e.id]=t.data,byteOffset:0})))}return Promise.resolve({buffer:this.glbBuffer.buffer,byteOffset:this.glbBuffer.byteOffset})}l(t,e,i,n=0){const s=this.gltf,r=s.accessors[e],o=void 0!==r.bufferView?s.bufferViews[r.bufferView]:{},h=(o.byteOffset||0)+n,a=this.p(r.type),u=g(r.componentType),c=o.byteStride||0,l={array:void 0,name:t,accessorName:e,byteLength:r.count*a*u.BYTES_PER_ELEMENT,componentType:r.componentType,count:r.count,type:r.type,itemSize:a};if(r.min&&(l.min=r.min),r.max&&(l.max=r.max),i)if(this.o)l.byteStride=c,l.byteOffset=h+(r.byteOffset||0),!c||c===a*u.BYTES_PER_ELEMENT||"indices"===t||"input"===t||"output"===t||t.indexOf("morph")>=0?(l.array=this.g(i,r.count,a,h+(r.byteOffset||0),u),l.array.buffer.byteLength===l.byteLength&&(l.byteOffset=0)):l.array=new Uint8Array(i,h,o.byteLength);else if(r.interleaved){l.byteStride=0,l.byteOffset=0;const t=new u(r.count*a);l.array=O(t,i,r.count,a,c,h+(r.byteOffset||0),r.componentType)}else l.byteStride=0,l.array=this.g(i,r.count,a,h+(r.byteOffset||0),u),l.byteOffset=l.array.byteOffset;else{l.array=new u(r.count);const t=l.min||l.max;t&&(l.array[0]=t[0],l.array[1]=t[1],l.array[2]=t[2])}return l}h(){const t=this.gltf.accessors;if(Array.isArray(t))for(let e=0;e<t.length;e++)for(let i=0;i<t.length;i++)e!==i&&t[e].bufferView===t[i].bufferView&&(t[e].interleaved=t[i].interleaved=!0);else for(const e in t)for(const i in t)e!==i&&t[e].bufferView===t[i].bufferView&&(t[e].interleaved=t[i].interleaved=!0)}g(t,e,i,n,s){return n%s.BYTES_PER_ELEMENT!=0&&(t=t.slice(n,n+e*i*s.BYTES_PER_ELEMENT),n=0),new s(t,n,i*e)}p(t){const e=k.indexOf(t);return k[e+1]}requestKHRTechniquesWebgl(t){const{shaders:e}=t,i=e.map((t=>{if(void 0!==t.bufferView){const e=this.gltf.bufferViews[t.bufferView],{byteLength:i}=e;return this.m(e).then((n=>{const{buffer:s,byteOffset:r}=n,o=A(s,r+(e.byteOffset||0),i);return t.content=o,t}))}if(t.uri){if(_(t.uri)){const e=y(t.uri),i=A(e,0,e.byteLength);return t.content=i,Promise.resolve(t)}{const e=this.rootPath+"/"+t.uri;return P.get(e).then((e=>(t.content=e,t)))}}return Promise.resolve(t)}));return Promise.all(i).then((()=>t))}}class C{constructor(t,e,i){this.rootPath=t,this.gltf=e,this.requests={},this.buffers={},this.glbBuffer=i,this.accessor=new I(t,e,i)}iterate(t,e){const i=this.gltf[e];if(!i)return;let n=0;for(const e in i)t(e,i[e],n++)}createNode(t){const e={};if(m(t.name)&&(e.name=t.name),m(t.children)&&(e.children=t.children),m(t.jointName)&&(e.jointName=t.jointName),m(t.matrix)&&(e.matrix=t.matrix),m(t.rotation)&&(e.rotation=t.rotation),m(t.scale)&&(e.scale=t.scale),m(t.translation)&&(e.translation=t.translation),m(t.extras)&&(e.extras=t.extras),m(t.meshes)&&(e.mesh=t.meshes[0]),e.translation||e.rotation||e.scale){const t=function(t,e){if(e.matrix)return e.matrix;if(e.translation||e.scale||e.rotation){const n=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}(v,e.translation||x),s=function(t,e){var i=e[0],n=e[1],s=e[2],r=e[3],o=i+i,h=n+n,a=s+s,u=i*o,c=n*o,l=n*h,f=s*o,d=s*h,m=s*a,p=r*o,g=r*h,_=r*a;return t[0]=1-l-m,t[1]=c+_,t[2]=f-g,t[3]=0,t[4]=c-_,t[5]=1-u-m,t[6]=d+p,t[7]=0,t[8]=f+g,t[9]=d-p,t[10]=1-u-l,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(b,e.rotation||S),r=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(w,e.scale||M);return i(r,s,r),i(t,n,r)}return function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(t)}([],e);delete e.translation,delete e.rotation,delete e.scale,e.matrix=t}return e}_(t){const e={};for(const i in t){const n=t[i];let s,r;n.instanceTechnique&&n.instanceTechnique.values?(s=n.instanceTechnique,r=s.values.diffuse):(s=n,r=s.values.tex||s.values.diffuseTex||s.values.diffuse);const o={baseColorTexture:{index:r}};n.name&&(o.name=n.name),n.extensions&&(o.extensions=n.extensions),n.extras&&(o.extras=n.extras),e[i]=o}return e}v(t){if(t.bufferView||t.extensions&&(t.extensions.KHR_binary_glTF||t.extensions.binary_glTF)){const e=t.bufferView?t:t.extensions.KHR_binary_glTF||t.extensions.binary_glTF;if(t.extensions&&(t.mimeType=e.mimeType,t.width=e.width,t.height=e.height),this.buffers[e.bufferView])return Promise.resolve(this.buffers[e.bufferView]);const i=this.gltf.bufferViews[e.bufferView],n=(i.byteOffset||0)+this.glbBuffer.byteOffset,s=i.byteLength,r=this.buffers[e.bufferView]=new Uint8Array(this.glbBuffer.buffer,n,s);return Promise.resolve(r)}{const e=t.uri,i=this.rootPath+"/"+e;return this.requests[i]?this.requests[i].then((()=>this.buffers[i])):this.requests[i]=P.getArrayBuffer(i,null).then((t=>{const e=t.data;return this.buffers[i]=e,new Uint8Array(e)}))}}S(t){const e=this.gltf.textures[t];if(!e)return null;const i=this.gltf.images[e.source];return this.v(i).then((t=>{const n=this.gltf.samplers[e.sampler];return{image:{array:t,width:i.width,height:i.height,index:e.source,mimeType:i.mimeType,name:i.name,extras:i.extras},type:e.type||5121,sampler:n,format:e.format||6408,internalFormat:e.internalFormat||6408}}))}getBaseColorTexture(t){const e=this.gltf.materials[t];let i,n;if(e.instanceTechnique&&e.instanceTechnique.values?(i=e.instanceTechnique,n=i.values.diffuse):(i=e,n=i.values.tex||i.values.diffuseTex||i.values.diffuse),void 0===n||void 0===this.gltf.textures)return null;const s=this.gltf.textures[n];if(!s)return null;const r=this.gltf.samplers[s.sampler];return{format:s.format||6408,internalFormat:s.internalFormat||6408,type:s.type||5121,sampler:r,source:this.gltf.images[s.source]}}getMaterial(){return null}getAnimations(){return null}}class N{constructor(t,e,i,n,s){this.rootPath=t,this.gltf=e,this.glbBuffer=i,this.images={},this.buffers={},this.requests={},this.M=n,this.accessor=new I(t,e,i),this.decoders=s}iterate(t,e){const i=this.gltf[e];if(i)for(let e=0;e<i.length;e++)t(e,i[e],e)}createNode(t){const e={};return p(e,t),!m(t.weights)&&this.gltf.meshes&&m(e.mesh)?e.weights=this.gltf.meshes[e.mesh].weights:t.weights&&(e.weights=t.weights),e}S(t){const e=this.gltf.textures[t];if(!e)return null;const i=this.gltf.images[e.source];return this.v(i).then((t=>{if(!t)return null;const n={image:{array:t.data,width:t.width,height:t.height,index:e.source,mimeType:i.mimeType,name:i.name,extensions:i.extensions,extras:i.extras}};p(n,e);const s=m(e.sampler)?this.gltf.samplers[e.sampler]:void 0;return s&&(n.sampler=s),t.format&&(n.format=t.format),n}))}v(t){if(!m(t.bufferView))return this.O(t);{const e=this.gltf.bufferViews[t.bufferView];if(this.images[t.id])return Promise.resolve(this.images[t.id]);const i=this.gltf.buffers[e.buffer];if(i.uri)return this.T(i,e,t);if(this.glbBuffer)return this.A(e,t)}return null}O(t){const e=0===t.uri.indexOf("data:image/")?t.uri:this.rootPath+"/"+t.uri;return this.requests[t.id]?this.requests[t.id].then((()=>this.images[t.id])):this.requests[t.id]=this.P(t.id,e)}k(t,e){const i=this.decoders;if(i[e.mimeType])return i[e.mimeType](t);if("image/crn"===e.mimeType||"image/ktx2"===e.mimeType||"image/cttf"===e.mimeType)return console.warn("missing transcoder for "+e.mimeType,", visit https://maptalks.com/docs/transcoders for details"),Promise.resolve(null);{const i=new Blob([t],{type:e.mimeType}),n=URL.createObjectURL(i);return this.P(e.id,n)}}T(t,e,i){if(this.buffers[t.id]){const n=this.buffers[t.id],s=this.I(e,n);return this.k(s,i)}if(this.requests[t.id])return this.requests[t.id].then((()=>{const n=this.buffers[t.id],s=this.I(e,n);return this.k(s,i)}));if(_(t.uri)){const n=this.buffers[t.id]=y(t.uri),s=this.I(e,n);return this.k(s,i)}return this.requests[t.id]=P.getArrayBuffer(t.uri,null).then((n=>{const s=this.buffers[t.id]=n.data,r=this.I(e,s);return this.k(r,i)}))}A(t,e){const i=this.I(t,this.glbBuffer.buffer,this.glbBuffer.byteOffset);return this.k(i,e)}P(t,e){return new Promise(((i,n)=>{this.M(e,((s,r)=>{s?n(s):(URL.revokeObjectURL(e),this.images[t]=r,i(this.images[t]))}))}))}I(t,e,i){i=i||0;const n=t.byteOffset+i,s=t.byteLength;return new Uint8Array(e,n,s)}C(t,e){const i=new Array(t.byteLength);for(let e=0;e<t.byteLength;e++)i[e]=String.fromCharCode(t[e]);return i.join(""),"data:"+(e=e||"image/png")+";base64,"+function(t){return"undefined"!=typeof self?self.btoa(t):window.btoa(t)}(unescape(encodeURIComponent(i)))}getAnimations(t){const e=[];return t.forEach((t=>{e.push(this.getSamplers(t.samplers))})),Promise.all(e).then((e=>{for(let i=0;i<e.length;i++)t[i].samplers=e[i];return t}))}getSamplers(t){const e=[];for(let i=0;i<t.length;i++)(m(t[i].input)||m(t[i].output))&&(e.push(this.accessor.u("input",t[i].input)),e.push(this.accessor.u("output",t[i].output)));return Promise.all(e).then((e=>{for(let i=0;i<e.length/2;i++)t[i].input=e[2*i],t[i].output=e[2*i+1],t[i].interpolation||(t[i].interpolation="LINEAR");return t}))}}const F="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;class L{static read(t,e=0,i=0){i||(i=t.byteLength);const n=new DataView(t,e,i),s=n.getUint32(4,!0);if(1===s)return L.readV1(n,e);if(2===s)return L.readV2(t,e);throw new Error("Unsupported glb version : "+s)}static readV1(t,e){const i=t.getUint32(8,!0),n=t.getUint32(12,!0);if(i!==t.byteLength)throw new Error("Length in GLB header is inconsistent with glb's byte length.");const s=E(t.buffer,20+e,n);return{json:JSON.parse(s),glbBuffer:{byteOffset:20+e+n,buffer:t.buffer,byteLength:i}}}static readV2(t,e){let i,n,s;const r=new DataView(t,e+12);let o=0;for(;o<r.byteLength;){const h=r.getUint32(o,!0);o+=4;const a=r.getUint32(o,!0);if(o+=4,1313821514===a)i=E(t,e+12+o,h);else if(5130562===a){s=e+12+o,n=h;break}o+=h}return{json:JSON.parse(i),glbBuffer:{byteOffset:s,buffer:t,byteLength:n}}}}function E(t,e,i){if(F){const n=new Uint8Array(t,e,i);return F.decode(n)}return function(t){const e=t.length;let i="";for(let n=0;n<e;){let s=t[n++];if(128&s){let i=R[s>>3&7];if(!(64&s)||!i||n+i>e)return null;for(s&=63>>i;i>0;i-=1){const e=t[n++];if(128!=(192&e))return null;s=s<<6|63&e}}i+=String.fromCharCode(s)}return i}(new Uint8Array(t,e,i))}const R=[1,1,1,1,2,2,3,0],j=[0,0,0],D=[0,0,0,1],B=[1,1,1],U={TRANSLATION:[0,0,0],ROTATION:[0,0,0,1],SCALE:[1,1,1]},G={PREVIOUS:null,NEXT:null,PREINDEX:null,NEXTINDEX:null,INTERPOLATION:null},J={N(t,e,i,n,s,o,h,a){const u=m(t)?e.animations:[e.animations[0]],c={};for(let e=0;e<u.length;e++){const f=u[e];if(m(t)&&f.name!==t)continue;const d=f.channelsMap[i];if(d)for(let t=0;t<d.length;t++){const e=d[t];"translation"===e.target.path?(this.F(s,f.samplers[e.sampler],n,1),c.translation=r(j,s)):"rotation"===e.target.path?(this.L(o,f.samplers[e.sampler],n,1),c.rotation=l(D,o)):"scale"===e.target.path?(this.F(h,f.samplers[e.sampler],n,1),c.scale=r(B,h)):"weights"===e.target.path&&a&&(this.F(a,f.samplers[e.sampler],n,a.length),c.weights=a)}}return c},F(t,e,i,n){switch(e.interpolation){case"LINEAR":{const s=this.R(G,e,i,1*n);s&&(t=function(t,e,i,n){for(let s=0;s<t.length;s++)t[s]=e[s]+n*(i[s]-e[s]);return t}(t,s.PREVIOUS,s.NEXT,s.INTERPOLATION));break}case"STEP":{const s=this.R(G,e,i,1*n);s&&(t=function(t,e){for(let i=0;i<t.length;i++)t[i]=e[i];return t}(t,...s.PREVIOUS));break}case"CUBICSPLINE":{const s=this.R(G,e,i,3*n);s&&(t=this.j(t,s,e.input.array,3*n));break}}return t},L(t,e,i){switch(e.interpolation){case"LINEAR":{const n=this.R(G,e,i,1);n&&u(t,n.PREVIOUS,n.NEXT,n.INTERPOLATION);break}case"STEP":{const n=this.R(G,e,i,1);n&&(t=h(t,...n.PREVIOUS));break}case"CUBICSPLINE":{const n=this.R(G,e,i,3);if(n){for(let t=0;t<n.PREVIOUS.length;t++)n.PREVIOUS[t]=Math.acos(n.PREVIOUS[t]),n.NEXT[t]=Math.acos(n.NEXT[t]);t=this.j(t,n,e.input.array,3);for(let e=0;e<t.length;e++)t[e]=Math.cos(t[e])}break}}return t},D(t,e){const i=t.length;let n,s,r,o=0,h=i-1,a=Math.floor((o+h)/2);for(;o<=i-1&&h>=0;){if(o===h)return null;if(t[a]<=e&&e<=t[a+1]){const i=t[a];return n=a,s=a+1,r=(e-i)/(t[a+1]-i),{preIndx:n,nextIndex:s,interpolation:r}}e<t[a]?(h=a,a=Math.floor((o+h)/2)):t[a+1]<e&&(o=a,a=Math.floor((o+h)/2))}return null},R(t,e,i,n){const s=e.input.array,r=e.output.array,o=e.output.itemSize;(i<s[0]||i>s[s.length-1])&&(i=Math.max(s[0],Math.min(s[s.length-1],i))),i===s[s.length-1]&&(i=s[0]);const h=this.D(s,i);if(!h||!h.nextIndex)return null;const{preIndx:a,nextIndex:u,interpolation:c}=h;t.PREINDEX=a,t.NEXTINDEX=u,t.INTERPOLATION=c;const l=o*n;return t.PREVIOUS=r.subarray(t.PREINDEX*l,(t.PREINDEX+1)*l),t.NEXT=r.subarray(t.NEXTINDEX*l,(t.NEXTINDEX+1)*l),t},j(t,e,i,n){const s=e.INTERPOLATION,r=i[e.PREINDEX],o=i[e.NEXTINDEX];for(let i=0;i<3;i++){const h=e.PREVIOUS[n+i],a=(o-r)*e.PREVIOUS[2*n+i],u=e.NEXT[3+i],c=(o-r)*e.NEXT[i],l=(2*Math.pow(s,3)-3*Math.pow(s,2)+1)*h+(Math.pow(s,3)-2*Math.pow(s,2)+s)*a+(2*-Math.pow(s,3)+3*Math.pow(s,2))*u+(Math.pow(s,3)-Math.pow(s,2))*c;t[i]=l}return t},getAnimationClip(t,e,i,n){const s=t.nodes[e]&&t.nodes[e].weights;return o(j,...U.TRANSLATION),h(D,...U.ROTATION),o(B,...U.SCALE),this.N(n,t,e,i,j,D,B,s)},getTimeSpan(t){if(!t.animations)return null;if(t.timeSpan)return t.timeSpan;const e=t.animations;return t.timeSpan={},e.forEach(((e,i)=>{let n=-1/0,s=1/0;const r=e.channels;for(let t=0;t<r.length;t++){const i=r[t],o=e.samplers[i.sampler].input.array;o[o.length-1]>n&&(n=o[o.length-1]),o[0]<s&&(s=o[0])}const o=e.name||i;t.timeSpan[o]={max:n,min:s}})),t.timeSpan},getTimeSpanByName(t,e){const i=this.getTimeSpan(t);return i?m(e)?i[e]:i[Object.keys(i)[0]]:null}};let z=!1;"undefined"!=typeof OffscreenCanvas&&"undefined"!=typeof createImageBitmap&&(z=!0);const V="undefined"==typeof document?null:document.createElement("canvas");class q{constructor(t,e,i){if(this.options=i||{},this.options.decoders||(this.options.decoders={}),e.buffer instanceof ArrayBuffer){const{json:i,glbBuffer:n}=L.read(e.buffer,e.byteOffset,e.byteLength);this.B(t,i,n)}else this.B(t,e);this.U=new I(this.rootPath,this.gltf,this.glbBuffer),this.G()}G(){const t=this.gltf.extensionsRequired;if(t){if(t.indexOf("KHR_draco_mesh_compression")>=0&&!this.options.decoders.draco)throw new Error("KHR_draco_mesh_compression is required but @maptalks/transcoders.draco is not loaded");if(t.indexOf("KHR_texture_basisu")>=0&&!this.options.decoders.ktx2)throw new Error("KHR_texture_basisu is required but @maptalks/transcoders.ktx2 is not loaded")}}J(){const t=this.gltf.extensions;return t&&t.KHR_techniques_webgl?this.U.requestKHRTechniquesWebgl(t.KHR_techniques_webgl).then((e=>(t.KHR_techniques_webgl=e,t))):Promise.resolve(t)}load(t){t=t||{};const e=this.V(t),i=this.q(),n=this.$(),s=this.J();return Promise.all([e,i,n,s]).then((t=>(t[0].animations=t[1],t[0].textures=t[2],t[0].extensions=t[3],t[0].transferables=this.transferables||[],this.createChannelsMap(t[0]),t[0])))}createChannelsMap(t){const e=t.animations;if(e)for(let t=0;t<e.length;t++){const i=e[t];i.channelsMap={};for(let t=0;t<i.channels.length;t++){const e=i.channels[t];i.channelsMap[e.target.node]||(i.channelsMap[e.target.node]=[]),i.channelsMap[e.target.node].push(e)}}}getExternalResources(){const t=[];if(this.gltf){const{buffers:e,images:i}=this.gltf;for(let i=0;i<e.length;i++)e[i].uri&&e[i].uri.indexOf("data:application/octet-stream;base64")<0&&t.push({type:"buffer",uri:e[i].uri});for(let e=0;e<i.length;e++)i[e].uri&&i[e].uri.indexOf("data:image/")<0&&t.push({type:"image",uri:i[e].uri})}return t}static getAnimationClip(t,e,i,n){return J.getAnimationClip(t,e,i,n)}static getAnimationTimeSpan(t,e){return J.getTimeSpanByName(t,e)}static getTypedArrayCtor(t){return g(t)}static readInterleavedArray(t,e,i,n,s,r,o){return O(t,e,i,n,s,r,o)}B(t,e,i){this.gltf=e,this.glbBuffer=i,this.version=e.asset?+e.asset.version:1,this.rootPath=t,this.buffers={},this.requests={},this.options.requestImage=this.options.requestImage||(z?X:$),this.options.transferable&&(this.transferables=[]),2===this.version?(this.adapter=new N(t,e,i,this.options.requestImage,this.options.decoders||{}),this.adapter.iterate(((t,e,i)=>{e.id="buffer_"+i}),"buffers"),this.adapter.iterate(((t,e,i)=>{e.id="image_"+i}),"images"),this.adapter.iterate(((t,e,i)=>{e.id="accessor_"+i}),"accessors")):(this.adapter=new C(t,e,i),this.adapter.iterate(((t,e,i)=>{e.id="accessor_"+i}),"accessors"))}H(t,e){if(t.children&&t.children.length>0){if(!("number"==typeof(i=t.children[0])&&isFinite(i)||function(t){return!d(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}(t.children[0])))return t;const n=t.children.map((t=>{const i=e[t];return i.nodeIndex=t,this.H(i,e)}));t.children=n}var i;return t}V(t){return this.W(t).then((t=>{const e=this.scenes=[];let i;for(const e in t)t[e]=this.H(t[e],t),t[e].nodeIndex=Number(e)?Number(e):e;this.adapter.iterate(((n,s,r)=>{const o={};s.name&&(o.name=s.name),s.nodes&&(o.nodes=s.nodes.map((e=>t[e]))),this.gltf.scene===n&&(i=r),e.push(o)}),"scenes");const n={asset:this.gltf.asset,scene:i,scenes:e,nodes:t,meshes:this.meshes,materials:this.gltf.materials,skins:this.skins};if(this.gltf.extensions&&(n.extensions=this.gltf.extensions),1===this.version){const t=this.adapter._(this.gltf.materials);n.materials=t}return n}))}W(t){return this.X(t).then((()=>{const t=this.nodes={};return this.adapter.iterate(((e,i)=>{const n=this.adapter.createNode(i,this.meshes,this.skins);t[e]=n}),"nodes"),t}))}K(){this.skins=[];const t=[];return this.adapter.iterate(((e,i,n)=>{t.push(this.Z(i).then((t=>{t.index=n,this.skins.push(t)})))}),"skins"),t}Z(t){const e=t.inverseBindMatrices;return this.adapter.accessor.u("inverseBindMatrices",e).then((e=>(t.inverseBindMatrices=e,e&&e.buffer&&this.transferables&&this.transferables.indexOf(e.buffer)<0&&this.transferables.push(e.buffer),t)))}q(){const t=this.gltf.animations;return m(t)?this.adapter.getAnimations(t):null}X(t){this.meshes={};let e=[];return this.adapter.iterate(((i,n,s)=>{e.push(this.Y(n,t).then((t=>{t.index=s,this.meshes[i]=t})))}),"meshes"),e=e.concat(this.K()),Promise.all(e)}Y(t,e){const i=t.primitives.map((t=>this.tt(t,e))).filter((t=>!!t));return Promise.all(i).then((e=>{const i={};return p(i,t),i.primitives=e,i}))}$(){const t=this.gltf.textures;if(!t)return null;const e=[];for(const i in t)e.push(this.adapter.S(i));return Promise.all(e).then((e=>{if(this.transferables)for(let t=0;t<e.length;t++)if(e[t]&&e[t].image.array){const i=e[t].image.array.buffer;i&&this.transferables.indexOf(i)<0&&this.transferables.push(i)}if(!Array.isArray(t)){const i={},n=Object.keys(t);for(let t=0;t<e.length;t++)e[t]&&(i[n[t]]=e[t]);return i}return e}))}tt(t,e){let i;const n=t.extensions;if(n&&n.KHR_draco_mesh_compression){if(!this.options.decoders.draco&&(!this.gltf.extensionsRequired||!this.gltf.extensionsRequired.indexOf("KHR_draco_mesh_compression")<0))return null;const t=this.options.decoders.draco,{bufferView:s,attributes:r}=n.KHR_draco_mesh_compression,o=this.gltf.bufferViews[s];i=this.U.m(o).then((i=>{const{buffer:n,byteOffset:s}=i;let{byteOffset:h,byteLength:a}=o;h||(h=0);const u=new DataView(n,s+h,a),c={attributes:r,useUniqueIDs:!1,skipAttributeTransform:e.skipAttributeTransform};return t(u,c).then((t=>{const e=Object.values(t.attributes);return t.indices&&e.push(t.indices),e}))}))}else{const e=[],n=t.attributes;for(const t in n){const i=this.adapter.accessor.u(t,n[t]);i&&e.push(i)}if(m(t.indices)){const i=this.adapter.accessor.u("indices",t.indices);i&&e.push(i)}if(m(t.targets))for(let i=0;i<t.targets.length;i++){const n=t.targets[i];for(const t in n){const s=this.adapter.accessor.u(`morphTargets_${t}_${i}`,n[t]);s&&e.push(s)}}i=Promise.all(e)}return i.then((e=>{let i,n;const s={attributes:e.reduce(((t,e)=>("indices"===e.name?i=e:e.name.indexOf("morphTargets_")>-1?(n=n||{},n[e.name.slice(13)]=e):t[e.name]=e,this.transferables&&e.array.buffer&&this.transferables.indexOf(e.array.buffer)<0&&this.transferables.push(e.array.buffer),t)),{}),material:t.material};return i&&(s.indices=i),n&&(s.morphTargets=n),s.mode=m(t.mode)?t.mode:4,m(t.extras)&&(s.extras=t.extras),s}))}}function $(t,e){const i=new Image;i.crossOrigin="",i.onload=()=>{if(!V)return void e(new Error("There is no canvas to draw image!"));V.width=i.width,V.height=i.height;const t=V.getContext("2d");t.drawImage(i,0,0,i.width,i.height);const n=t.getImageData(0,0,i.width,i.height),s={width:i.width,height:i.height,data:new Uint8Array(n.data)};e(null,s)},i.onerror=function(t){e(t)},i.src=t}let H,W;function X(t,e){H||(H=new OffscreenCanvas(2,2),W=H.getContext("2d")),fetch(t).then((t=>t.blob())).then((t=>createImageBitmap(t))).then((t=>{H.width=t.width,H.height=t.height,W.drawImage(t,0,0);const i=W.getImageData(0,0,H.width,H.height);e(null,{width:t.width,height:t.height,data:new Uint8Array(i.data)})}))
/*!
     * @maptalks/gl v0.63.0
     * LICENSE : UNLICENSED
     * (c) 2016-2022 maptalks.com
     */}const K=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;throw new Error("unable to locate global object")},Z=K(),Y=Z.gl_trans__coders=Z.gl_trans__coders||{};Y.inject=function(t){const e=t.toString(),i=e.indexOf("{")+1,n=e.substring(0,i),s=Z.gl_trans__coders=Z.gl_trans__coders||{};let r=`${n}\n    const _____getGlobal = ${K.toString()};\n    const g___lobals = _____getGlobal()\n    const tran_____scoders = g___lobals['gl_trans__coders'] = g___lobals['gl_trans__coders'] || {};`;for(const t in s)"inject"!==t&&"getTranscoder"!==t&&"registerTranscoder"!==t&&(r+='tran_____scoders["'+t+'"] ='+s[t].toString()+"\n;");return r+="\n"+e.substring(n.length),r},Y.registerTranscoder=function(t,e){Y[t]=e},Y.getTranscoder=function(t){return Y[t]};const Q={"image/crn":Y.crn&&Y.crn(),"image/ktx2":Y.ktx2&&Y.ktx2(),"image/cttf":Y.ktx2&&Y.ktx2(),"draco":Y.draco&&Y.draco()};function tt(t,e,i){return new q(t,e,i).load()}function et(t){const e=t.lastIndexOf("/"),i=t.slice(0,e),n=t.slice(t.lastIndexOf(".")).toLowerCase();return".gltf"===n?function(t,e){return P.getJSON(t,e)}(t,{}).then((t=>t.message?t:tt(i,t,{decoders:Q,transferable:!0}))):".glb"===n?function(t,e){return P.getArrayBuffer(t,e)}(t,{}).then((t=>t.message?t:tt(i,{buffer:t.data,byteOffset:0},{decoders:Q,transferable:!0}))):null}t.onmessage=function(t){const e=t.data;if(e.url)!function(t){const e=t.data,i=t.callback;et(e.url).then((t=>{t.message?self.postMessage({callback:i,error:t}):self.postMessage({callback:i,data:t},t.transferables)})).catch((t=>{self.postMessage({callback:i,error:t})}))}(t);else{const i=t.callback;self.postMessage({callback:i,data:e})}},Object.defineProperty(t,"t",{value:!0})})),n(["exports","maptalks","@maptalks/gl"],(function(t,e,i){function n(t){if(t&&t.t)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(i){if("default"!==i){var n=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,n.get?n:{enumerable:!0,get:function(){return t[i]}})}})),e.default=t,Object.freeze(e)}var s=n(e);function r(t){return null==t}function o(t){return!r(t)}function h(t,e){const i=new Set(e);return Array.from(new Set(t.filter((t=>i.has(t)))))}function a(t,i,n=0){if(!(t&&i instanceof e.Coordinate))return null;const s=t.coordinateToPointAtRes(i,t.getGLRes());return[s.x,s.y,n]}for(
/*!
      * Contains code from THREE.js
      * MIT License
      * https://github.com/mrdoob/three.js
      */
var u=[],c=0;c<6;c++)u[c]=[];var l=[];function f(t,e,i){var n,s,r,o,h,a,c,f,d,g,_,y,v,b,w,x,S;s=(n=t)[0],r=n[1],o=n[2],h=n[3],a=n[4],c=n[5],f=n[6],d=n[7],g=n[8],_=n[9],y=n[10],v=n[11],b=n[12],w=n[13],x=n[14],S=n[15],m(u[0],h-s,d-a,v-g,S-b),m(u[1],h+s,d+a,v+g,S+b),m(u[2],h+r,d+c,v+_,S+w),m(u[3],h-r,d-c,v-_,S-w),m(u[4],h-o,d-f,v-y,S-x),m(u[5],h+o,d+f,v+y,S+x);for(var M=0;M<6;M++)if(!i||"0"!==i.charAt(M)){var O=u[M];if(l[0]=O[0]>0?e[1][0]:e[0][0],l[1]=O[1]>0?e[1][1]:e[0][1],l[2]=O[2]>0?e[1][2]:e[0][2],p(O,l)<0)return!1}return!0}var d=1/6;function m(t,e,i,n,s){return t[0]=e*d,t[1]=i*d,t[2]=n*d,t[3]=s*d,t}function p(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]}const g={};const _=[-1,0,-1,1,0,-1,-1,0,1,1,0,1],y=[0,1,0,0,1,0,0,1,0,0,1,0],v=[3,1,0,0,2,3],b=[0,0,1,0,0,1,1,1],w=[-.8111000061035156,2.0102999210357666,-.8111000061035156,0,.010300000198185444,-0,-.8111000061035156,2.0102999210357666,.8111000061035156,-.8111000061035156,2.0102999210357666,.8111000061035156,0,.010300000198185444,-0,.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,.8111000061035156,0,.010300000198185444,-0,.8111000061035156,2.0102999210357666,-.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,0,.010300000198185444,-0,-.8111000061035156,2.0102999210357666,-.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,-.8111000061035156,2.0102999210357666,-.8111000061035156,0,2.9419000148773193,-0,.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,0,2.9419000148773193,-0,-.8111000061035156,2.0102999210357666,-.8111000061035156,-.8111000061035156,2.0102999210357666,.8111000061035156,0,2.9419000148773193,-0,-.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,.8111000061035156,0,2.9419000148773193,-0],x=[-.9267006516456604,-.3758002817630768,-0,-.9267006516456604,-.3758002817630768,-0,-.9267006516456604,-.3758002817630768,-0,0,-.3758002817630768,.9267006516456604,0,-.3758002817630768,.9267006516456604,0,-.3758002817630768,.9267006516456604,.9267006516456604,-.3758002817630768,-0,.9267006516456604,-.3758002817630768,-0,.9267006516456604,-.3758002817630768,-0,0,-.3758002817630768,-.9267006516456604,0,-.3758002817630768,-.9267006516456604,0,-.3758002817630768,-.9267006516456604,0,.656676173210144,-.7541726231575012,0,.656676173210144,-.7541726231575012,0,.656676173210144,-.7541726231575012,.7541726231575012,.656676173210144,-0,.7541726231575012,.656676173210144,-0,.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,0,.656676173210144,.7541726231575012,0,.656676173210144,.7541726231575012,0,.656676173210144,.7541726231575012],S=[.375,1,.625,.75,.375,.75,.375,.75,.625,.5,.375,.5,.375,.5,.625,.25,.375,.25,.375,.25,.625,0,.375,0,.375,.25,.375,0,.375,.25,.375,.5,.375,.25,.375,.5,.375,1,.375,.75,.375,1,.375,.75,.375,.5,.375,.75],M=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],O={"cube":{meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1])},NORMAL:{array:new Int8Array([0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1])}},indices:new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]),mode:4}]}],scenes:[{nodes:[{mesh:0}]}]},"plane":{meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array(_)},NORMAL:{array:new Int8Array(y)},TEXCOORD_0:{array:new Int8Array(b)}},indices:new Uint16Array(v),mode:4}]}],scenes:[{nodes:[{mesh:0}]}]},"pyramid":{meshes:[{primitives:[{attributes:{POSITION:{array:new Float32Array(w)},NORMAL:{array:new Float32Array(x)},TEXCOORD_0:{array:new Float32Array(S)}},indices:new Uint16Array(M),mode:4}]}],scenes:[{nodes:[{mesh:0}]}]}};class T extends s.worker.Actor{constructor(t,e){super(t),this.mapId=e}loadGLTF(t,e){this.et||(this.et=new i.reshader.GLTFManager(this.regl));const n=function(t){let e=document.createElement("a");return e.href=t,t=e.href,e=null,t}(t),s={url:n};this.send(s,null,((t,i)=>{t?e(t):e(t,i)}))}addLayer(t,e,i){const n={actorId:this.actorId,mapId:this.mapId,layerId:t,command:"addLayer",params:{options:e}};this.broadcast(n,null,i)}removeLayer(t,e){const i={mapId:this.mapId,layerId:t,command:"removeLayer"};this.broadcast(i,null,e)}}let A=0;const P=[],k=[],I={"lightAmbient":[1,1,1],"lightDiffuse":[1,1,1],"lightSpecular":[1,1,1],"lightDirection":[1,1,1]},C=[186/255,186/255,186/255,1],N=[.2107,-.0202],F=[],L=[],E=[],R=[],j=[1,1,1],D=function(t,e){const i=[];return i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=0,i[4]=t[3],i[5]=t[4],i[6]=t[5],i[7]=0,i[8]=t[6],i[9]=t[7],i[10]=t[8],i[11]=0,i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=1,i}(function(t){const e=Math.cos(t),i=Math.sin(t),n=[];return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=e,n[5]=i,n[6]=0,n[7]=-i,n[8]=e,n}(.5*Math.PI),[0,0,0]),B={"points":0,"lines":1,"line strip":2,"line loop":3},U=[];class G extends s.renderer.OverlayLayerCanvasRenderer{constructor(t){super(t),this.gltfScenes={},this.it={}}onAdd(){super.onAdd(),this.prepareWorker()}draw(t,e){A=t,this.prepareCanvas(),this.nt(e,t)}drawOnInteracting(t,e,i){A=e,this.nt(i,e)}needToRedraw(){const t=this.layer.st();for(const e in t){if(t[e].isDirty()&&this.rt&&this.rt.length)return!0}return super.needToRedraw()}onRemove(){this.workerConn&&(this.workerConn.removeLayer(this.layer.getId(),(t=>{if(t)throw t})),this.workerConn.remove(),delete this.workerConn),super.onRemove()}hitDetect(){return!1}createContext(){const t=this.canvas.gl&&this.canvas.gl.wrap;if(t)this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl;else{const t=this.layer.options.glOptions||{alpha:!0,depth:!0,stencil:!0};this.glOptions=t,this.gl=this.gl||this.ot(this.canvas,t),this.regl=i.createREGL({gl:this.gl,optionalExtensions:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives","OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","WEBGL_compressed_texture_s3tc"]})}t&&(this.canvas.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height)),this.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height),this.et=this.regl.gltfManager=this.regl.gltfManager||new i.reshader.GLTFManager(this.regl),this.ht(),this.at(),this.ut&&this.ut.forEach((t=>{t.generateInstancedBuffers(this.regl)})),this.ct&&this.ct.forEach((t=>{t.generateBuffers(this.regl)})),this.layer.fire("contextcreate",{regl:this.regl})}at(){const t=this.layer.getMap(),e=new i.reshader.Renderer(this.regl);this.renderer=e,this.lt={"projMatrix":t.projMatrix,"projViewMatrix":t.projViewMatrix,"viewMatrix":t.viewMatrix,"cameraPosition":t.cameraPosition,"altitudeScale":1},i.reshader.pbr.PBRUtils.loginIBLResOnCanvas(this.canvas,this.regl,t),this.ft=new i.reshader.FBORayPicking(e,{vert:"attribute vec3 aPosition;\n\nuniform mat4 projViewMatrix;\n\nuniform mat4 modelMatrix;\n\nuniform mat4 positionMatrix;\n\nuniform float pointSize;\n\n//引入fbo picking的vert相关函数\n\n#include <fbo_picking_vert>\n\n#include <get_output>\n\nvoid main()\n\n{\n\n    mat4 localPositionMatrix = getPositionMatrix();\n\n    gl_Position = projViewMatrix * modelMatrix * localPositionMatrix * getPosition(aPosition);\n\n    gl_PointSize = pointSize;\n\n    //传入gl_Position的depth值\n\n    fbo_picking_setData(gl_Position.w, true);\n\n}\n\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return i.mat4.multiply([],e.projViewMatrix,e.modelMatrix)}}]},this.pickingFBO)}prepareWorker(){const t=this.layer.getMap();this.workerConn||(this.workerConn=new T("@maptalks/gltf-layer",t.id));const e=this.workerConn;if(!e.isActive())return;const i=this.layer.options||{},n=this.layer.getId();e.addLayer(n,i,(t=>{if(t)throw t;this.layer&&(this.ready=!0,this.layer.fire("workerready"))}))}dt(t){const e=g;for(const i in e){if(this.it[i])continue;const n=e[i];this.gt(t,n.name,n.type,n.config)}}_t(t){const e=t.getShader(),i=t.getUrl();if(!this.et)return;if(O[i]){const i=this.gltfScenes[t.yt()];if(!i)return;const n=i.modelMeshes;return"wireframe"===e&&n.forEach((t=>{this.vt(t.properties.geometryResource)})),void this.bt(t,n)}const n=this.et.getGLTF(i),s=this.gltfScenes[t.yt()];if(!n||!s)return;const r=s.modelMeshes;"wireframe"===e&&n.resources.forEach((t=>{this.vt(t)})),this.bt(t,r)}bt(t,e){const i=t.getShader();e.forEach((e=>{const n=this.wt(t,e.properties.geometryResource);e.geometry="wireframe"===i?e.properties.geometryResource.copyGeometry:e.properties.geometryResource.geometry,e.material=n}))}vt(t){t.copyGeometry.data.aBarycentric||(t.copyGeometry.buildUniqueVertex(),t.copyGeometry.createBarycentric("aBarycentric"),this.regl?t.copyGeometry.generateBuffers(this.regl):(this.ct=this.ct||[],this.ct.push(t.copyGeometry)))}gt(t,e,n,r){this.viewport={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},r.extraCommandProps||(r.extraCommandProps={});const o={};t&&this.xt(o,P,t);const h=s.Util.extend({},r);h.extraCommandProps=s.Util.extend({},r.extraCommandProps),h.extraCommandProps.viewport=this.viewport,h.uniforms=s.Util.extend([],r.uniforms,P),h.defines=s.Util.extend({},h.defines,o),n.indexOf(".")>-1?(n=n.split("."),this.it[e]={shader:new i.reshader[n[0]][n[1]](h),type:n}):this.it[e]={shader:new i.reshader[n](h),type:n}}remove(){this.St();const t=this.it;for(const e in t)t[e].shader.dispose();this.rt&&this.rt.forEach((t=>{t.mesh.dispose()})),this.Mt&&this.Mt.clear(),this.Ot&&this.Ot.clear(),this.Tt&&this.Tt.clear(),super.remove()}clearCanvas(){this.canvas&&(this.regl.clear({color:[0,0,0,0],depth:1,stencil:0}),super.clearCanvas())}resizeCanvas(t){super.resizeCanvas(t),this.pickingFBO&&this.pickingFBO.resize(this.canvas.width,this.canvas.height),this.layer.fire("resizecanvas",{size:t})}nt(t,e){let n=0;if(this.At(t),e!==this.Pt&&(this.kt=!0,this.rt=this.rt||[],this.rt.splice(0,this.rt.length),this.It=!1,this.dt(t)),function(t){let e;for(e in t)return!1;return!0}(this.gltfScenes))return;const r=this.layer.getGeometries().filter((t=>(t.isDirty()&&(this.kt=!0),this.layer.isVisible()&&t.isVisible()&&t.Ct())));if(r.length&&(this.It||this.Pt===e||(this.Nt(r),this.It=!0),e!==this.Pt&&(this.rt=this.Ft(r)),this.rt.length)){for(const e in this.it){if(!r.filter((t=>t.getShader()===e)).length)continue;const o=this.Lt(t&&t.renderMode,e);let h=this.it[e].shader;o.triangle.sortMeshes(this.lt.cameraPosition),this.lt.outSize=[this.canvas.width,this.canvas.height];let a=null,u={};if(t){if(t.includes){const{newShader:i,uniforms:n}=this.Et(t,h,this.it[e].type);this.it[e].shader=h=i,s.Util.extend(u,n)}this.lt.halton=t.jitter||[0,0],a=t.renderTarget&&t.renderTarget.fbo,u=this.Rt(t,h,u)}else this.lt.halton=N;this.jt=t,s.Util.extend(u,this.lt),h="pbr"!==e||i.reshader.pbr.PBRUtils.isSupported(this.regl)?t&&t.onlyUpdateDepthInTaa?this.it.depth.shader:this.it[e].shader:t&&t.onlyUpdateDepthInTaa?this.it.depth.shader:this.it.phong.shader,h.filter=t&&t.sceneFilter||null,this.renderer.render(h,u,o.triangle,a);if(o.pointLine.getMeshes().length){u.pointSize=this.layer.options.pointSize||1;const e=this.it.pointline.shader;e.filter=t&&t.sceneFilter||null,this.renderer.render(e,u,o.pointLine,a)}n++}this.Dt=!0,(!t||t&&t.isFinalRender)&&(this.completeRender(),this.layer.fire("rendercomplete-debug",{count:n})),this.Pt=e}}Lt(t,e){const n=[],s=[];for(let i=0;i<this.rt.length;i++)if(this.rt[i].shader===e){const e=this.rt[i].mesh;this.Bt(t,e,n,s)}return this.Ot=this.Ot||new i.reshader.Scene,this.Mt=this.Mt||new i.reshader.Scene,{pointLine:this.Ot.setMeshes(n),triangle:this.Mt.setMeshes(s)}}getFrameTimestamp(){return this.Pt}getFrameContext(){return this.jt}supportRenderMode(){return!0}needRetireFrames(){return this.kt}xt(t,e,i){const n=i&&i.includes;if(n)for(const r in n)n[r]&&(i[r].uniformDeclares&&(e.length=0,e.push(...i[r].uniformDeclares)),i[r].defines&&s.Util.extend(t,i[r].defines))}Ut(t,e){const i=e&&e.includes;if(i)for(const n in i)i[n]&&e[n].renderUniforms&&s.Util.extend(t,e[n].renderUniforms)}Et(t,e,n){const r={},o={};this.xt(r,P,t),this.Ut(o,t);const h={vert:e.vert,frag:e.frag,uniforms:e.uniforms,extraCommandProps:e.extraCommandProps};h.defines=r,h.uniforms=s.Util.extend([],h.uniforms,P);let a=null;return t.states.includesChanged?(a=Array.isArray(n)?new i.reshader[n[0]][n[1]](h):new i.reshader[n](h),e.dispose()):a=e,{uniforms:o,newShader:a}}Rt(t,e,i){if(t.viewshed){for(const e in t.viewshed.renderUniforms)i[e]=t.viewshed.renderUniforms[e];s.Util.extend(e.shaderDefines,t.viewshed.defines)}if(t.floodAnalysis){for(const e in t.floodAnalysis.renderUniforms)i[e]=t.floodAnalysis.renderUniforms[e];s.Util.extend(e.shaderDefines,t.floodAnalysis.defines)}return i}getShadowMeshes(){let t=[];if(!this.layer||!this.layer.isVisible())return t;const e=this.layer.getGeometries();for(let i=0;i<e.length;i++)if(e[i].isCastShadow()&&e[i].isVisible()&&e[i].Ct()){const n=e[i].yt();this.gltfScenes[n]&&(t=t.concat(this.gltfScenes[n].modelMeshes))}return t}Gt(){return this.rt?this.rt.map((t=>t.mesh)):U}getAnalysisMeshes(){return this.Gt()}drawOutline(t){this.extentShader||(this.extentShader=new i.reshader.MeshShader({vert:"attribute vec3 aPosition;\n\nuniform mat4 projViewMatrix;\n\nuniform mat4 modelMatrix;\n\nuniform mat4 positionMatrix;\n\n#include <get_output>\n\nvoid main()\n\n{\n\n    mat4 localPositionMatrix = getPositionMatrix();\n\n    gl_Position = projViewMatrix * modelMatrix * localPositionMatrix * getPosition(aPosition);\n\n}\n\n",frag:"precision highp float;\n\nvoid main() {\n\n    gl_FragColor = vec4(1.0);\n\n}\n\n",positionAttribute:"POSITION",extraCommandProps:{viewport:this.viewport,cull:{enable:!1}}}));const e=this.getOutlineMeshes();e.length&&(this.Tt=this.Tt||new i.reshader.Scene,this.Tt.setMeshes(e),this.renderer.render(this.extentShader,{"projViewMatrix":this.lt.projViewMatrix},this.Tt,t))}getOutlineMeshes(){let t=[];if(!this.layer)return t;const e=this.layer.getGeometries();for(let i=0;i<e.length;i++)if(e[i].isOutline()&&e[i].isVisible()&&e[i].Ct()){const n=e[i].yt();this.gltfScenes[n]&&(t=t.concat(this.gltfScenes[n].modelMeshes))}return t}Nt(t){t.forEach((t=>{const e=t.yt();if(!this.gltfScenes[e])return;t.isLoaded()&&(t.Jt=t.getUrl()),this.zt(e),t.isAnimated()||t.hasFunctionDefinition()||t.isOutline()||t.isDashAnimated()?t.setDirty(!0):t.setDirty(!1);const n=t.getScale();t.Vt=i.vec3.copy(t.Vt||[],n);const s=t.getRotation();t.qt=i.vec3.copy(t.qt||[],s),t.$t()&&t.Ht()}))}Wt(t,e){return!("wireframe"===e&&!t.geometry.data.aBarycentric)}Ft(t){const e=this.rt||[],n=this.layer.getMap();for(let s=0;s<t.length;s++){const r=t[s],o=r.getShader(),h=this.gltfScenes[r.yt()];if(!h)continue;const a=h.modelMeshes;for(let t=0;t<a.length;t++){const s=a[t];this.Wt(s,o)&&(this.Xt(s,r),this.Kt(s,r),this.Zt(s,r),s.setUniform("uPickingId",r.yt()),s.properties.isAnimated=r.isAnimated(),(s instanceof i.reshader.InstancedMesh||f(n.projViewMatrix,s.getBoundingBox()))&&e.push({shader:o,mesh:s}))}r.Yt()}return e}Bt(t,e,i,n){const s=e.properties.isAnimated;"fxaaAfterTaa"===t&&s?this.Qt(e,i,n):"taa"!==t||s?"default"===t||"fxaa"===t?this.Qt(e,i,n):t||this.Qt(e,i,n):this.Qt(e,i,n)}te(t,e,n){const s=t;s.copy(),"wireframe"===n&&s.createCopyBarycentric();const r=this.ee(e,s,n),o=r.getDefines();return r instanceof i.reshader.InstancedMesh?(o.HAS_PICKING_ID=1,o.HAS_INSTANCE_COLOR=1):o.HAS_PICKING_ID=2,r.geometry.data.COLOR_0&&(o.HAS_COLOR0=1),s.extraInfo&&"MASK"===s.extraInfo.alphaMode&&(o.HAS_ALPHAMODE=1),r.setDefines(o),r}ee(t,e,n){const s=this.layer.st()[t],r=s.getGLTFMarkerType();let o=null;const h=e.material?e.material:this.wt(s,e);e.material=h;const a="wireframe"===n?e.copyGeometry:e.geometry;if(this.regl?a.generateBuffers(this.regl):(this.ct=this.ct||[],this.ct.push(a)),"groupgltfmarker"===r){s.ie();const t=s.ne(i.mat4.identity(R)),e=s.getCount();o=new i.reshader.InstancedMesh(t,e,a,h),this.regl?o.generateInstancedBuffers(this.regl):(this.ut=this.ut||[],this.ut.push(o))}else o=new i.reshader.Mesh(a,h);o.nodeMatrix=i.mat4.copy([],e.nodeMatrix),o.properties.geometryResource=e,s.isBloom()&&(o.bloom=1),o.transparent=s.se();const u=e.extraInfo;return"BLEND"!==u.alphaMode&&"MASK"!==u.alphaMode||(o.transparent=!0),this.Zt(o,s),o}Qt(t,e,i){B[t.geometry.desc.primitive]<4?e.push(t):i.push(t)}wt(t,e){let n=null;const s=t.getShader(),r=t.getUniforms()||{},o=e.materialInfo||{};if("phong"===s)if("pbrSpecularGlossiness"===o.name)n=new i.reshader.PhongSpecularGlossinessMaterial(o);else{for(const t in I)r[t]=r[t]||I[t];n=new i.reshader.PhongMaterial(o)}else if("wireframe"===s)n=new i.reshader.WireFrameMaterial(o);else if("pbr"===s){if(n="pbrSpecularGlossiness"===o.name?new i.reshader.pbr.StandardSpecularGlossinessMaterial(o):new i.reshader.pbr.StandardMaterial(o),this.regl&&!i.reshader.pbr.PBRUtils.isSupported(this.regl)){n=i.reshader.PhongMaterial.convertFrom(n);for(const t in I)r[t]=r[t]||I[t]}}else n=new i.reshader.Material(o);n.doubleSided=e.extraInfo&&e.extraInfo.doubleSided?1:0;for(const t in r)n.set(t,r[t]);return e.morphWeights&&this.re(e.morphWeights,n),e.skin&&(n.set("jointTextureSize",[4,6]),n.set("numJoints",e.skin.numJoints),n.set("jointTexture",e.skin.jointTexture),n.set("skinAnimation",0)),n}re(t,e){const i=e.get("morphWeights1")||[],n=e.get("morphWeights2")||[];for(let e=0;e<4;e++)i[e]=t[e]||0,n[e]=t[e+4]||0;e.set("morphWeights1",i),e.set("morphWeights2",n)}Zt(t,e){const i=e.getSymbol();i&&i.uniforms?(t.setUniform("polygonFill",i.uniforms.polygonFill||C),t.setUniform("polygonOpacity",void 0===i.uniforms.polygonOpacity?1:i.uniforms.polygonOpacity),t.setUniform("lineColor",i.uniforms.lineColor||C),t.setUniform("lineOpacity",void 0===i.uniforms.lineOpacity?1:i.uniforms.lineOpacity)):(t.setUniform("polygonFill",C),t.setUniform("polygonOpacity",1),t.setUniform("lineColor",C),t.setUniform("lineOpacity",1))}oe(t){const e=this.layer.getMap();if(!this.gltfScenes[t])return null;const n=this.gltfScenes[t].modelMeshes,r=this.layer.st()[t],o=this.he(n,r);if(!o)return null;const h=o.min,a=o.max,u=i.vec4.set(L,h[0],h[1],h[2],1),c=i.vec4.set(E,a[0],a[1],a[2],1),l=i.vec4.transformMat4(u,u,e.projViewMatrix),f=i.vec4.transformMat4(c,c,e.projViewMatrix),d=(l[0]/l[3]+1)*e.width/2,m=(1-l[1]/l[3])*e.height/2,p=(f[0]/l[3]+1)*e.width/2,g=(1-f[1]/l[3])*e.height/2,_=Math.min(d,p),y=Math.max(d,p),v=Math.min(m,g),b=Math.max(m,g);return new s.Extent({xmin:_,xmax:y,ymin:v,ymax:b})}St(){this.canvas&&i.reshader.pbr.PBRUtils.logoutIBLResOnCanvas(this.canvas,this.getMap())}At(t){const e=this.layer.getMap(),{iblTexes:n,dfgLUT:r}=i.reshader.pbr.PBRUtils.getIBLResOnCanvas(this.canvas);if(e&&e.getLightConfig()){const o=i.reshader.pbr.PBRUtils.getPBRUniforms(e,n,r,t&&t.ssr,t&&t.jitter),h=e.getLightConfig(),a=h.ambient&&h.ambient.color?h.ambient.color:[.2,.2,.2];this.lt.ambientColor=a,o&&s.Util.extend(this.lt,o)}else{const n=i.reshader.pbr.PBRUtils.getPBRUniforms(e,null,r,t&&t.ssr,t&&t.jitter);s.Util.extend(this.lt,n)}}Xt(t,e){"effectmarker"===e.getGLTFMarkerType()?e.updateUV(A):"glowmarker"===e.getGLTFMarkerType()&&e.ae();const i=e.getUniforms();if(i&&e.isDirty()&&e.ue())for(const e in i)t.material.set(e,i[e]);e.se()&&(t.transparent=!0),t.bloom=+!!e.isBloom(),"wireframe"===e.getShader()&&i&&i.dashAnimate&&t.material.set("time",A/1e3)}Kt(t,e){if("pbr"===e.getShader()){const e=t.getDefines(),{iblTexes:n}=i.reshader.pbr.PBRUtils.getIBLResOnCanvas(this.layer.getRenderer().canvas);n?e.HAS_IBL_LIGHTING=1:delete e.HAS_IBL_LIGHTING,t.setDefines(e)}}ce(t,e){const n=t.yt(),s=[],r=t.getShader(),o=this.et.getGLTF(e);if(o&&o.resources){if(!o.resources.length)return void this.layer.fire("modelerror",{type:"modelerror",marker:t,info:"there are no geomtries in the gltf model"});t.gltfPack=o.gltfPack,o.resources.forEach((t=>{const e=this.te(t,n,r);s.push(e)}))}else{const e=t.le();i.reshader.GLTFHelper.exportGLTFPack(e).getMeshesInfo().forEach((t=>{const e=this.te(t,n,r);s.push(e)}))}this.gltfScenes[n]&&this.fe(t,this.gltfScenes[n].modelMeshes),this.gltfScenes[n]={pickingId:n,modelMeshes:s},t.de()?t.de()&&(t.me([1,1,1]),t.pe([0,0,0]),this.ge(t,s)):this.ge(t,s),this.zt(n,!0),this.setToRedraw(),t.fire("createscene-debug",{scene:this.gltfScenes[n]})}_e(t,e){const i=t.getUrl();t.ye(e.json),this.layer.ve[i]+=1,this.ce(t,i),this._t(t),t.be(!0),t.fire("load",{data:e.json}),this.we()&&this.layer.fire("modelload",{models:this.layer.getGLTFUrls()}),t.fire("setUrl-debug"),this.kt=!0}loginGLTF(t){const e=this.et;if(!e)return;const i=t.getUrl();if(O[i])return void this.xe(t);const n=e.getGLTF(i);if(n)return this.et.loginGLTF(i,n),void this._e(t,n);this.workerConn.loadGLTF(i,((e,n)=>{if(e)return void this.layer.fire("modelerror",{type:"modelerror",marker:t,info:e});delete n.transferables,this.et.loginGLTF(i,n);const s=this.et.getGLTF(i);this._e(t,s)}))}logoutGLTF(t){const e=this.et;e&&!O[t]&&e.logoutGLTF(t)}ht(){const t=this.layer._geoList;for(let e=0;e<t.length;e++)this.loginGLTF(t[e])}we(){if(!this.layer)return;const t=this.layer._geoList;for(let e=0;e<t.length;e++)if(!t[e].isLoaded())return!1;return!0}xe(t){const e=function(t){let e=null;return O[t]&&(e={meshes:O[t].meshes},e.scenes=JSON.parse(JSON.stringify(O[t].scenes))),e}(t.getUrl());this._e(t,{json:e})}ge(t,e){this.zt(t.yt(),!0);let i=this.he(e,t);if(!i)return;const n=this.Se(t.de()||[],t,i);if(t.me(n),this.zt(t.yt(),!0),i=this.he(e,t),!i)return;const s=this.Me(t.Oe()||[],i,t);t.pe(s),t.Te=i}Se(t,e,n){const s=i.vec3.subtract(t,n.max,n.min),r=Math.max(...s);let o=null;o=e.de()?e.Ae():e.Pe();const h=function(t,e,i){return e*t.getGLScale(i)}(this.layer.getMap(),o,e.getZoomOnAdded()),a=h/r,u=i.vec3.set(t,a,a,a);return i.vec3.multiply(t,e.getScale(),u)}Me(t,e,n){if("groupgltfmarker"===n.getGLTFMarkerType())return i.vec3.set(t,0,0,-e.min[2]);if(!this.ke(n))return n.Oe();const s=n.getAnchorZ()||"bottom";let r=0;"bottom"===s?r=-e.min[2]:"top"===s?r=-e.max[2]:"center"===s&&(r=-(e.min[2]+e.max[2])/2);const o=n.getModelMatrix(),h=n.getTranslation();return i.vec3.set(t,-(e.min[0]+e.max[0])/2+o[12],-(e.min[1]+e.max[1])/2+o[13],r+h[2])}ke(t){const e=t.getUrl(),n=t.getScale(),s=t.getRotation(),r=t.getSymbol(),o=r&&r.fixSizeOnZoom;if((!o||o<0)&&t.Vt&&i.vec3.exactEquals(n,t.Vt)&&t.qt&&i.vec3.exactEquals(s,t.qt)&&t.Jt===e)return!1;const h=this.layer.getMap();return!(o>0&&!h.isZooming())}he(t,e){if(!t||!t.length)return null;if(!this.ke(e))return e.Te;"groupgltfmarker"===e.getGLTFMarkerType()&&t.forEach((t=>{const i=e.ne();for(const e in i)t.updateInstancedData(e,i[e]);t.updateBoundingBox()})),this.zt(e.yt(),!0);const n=t[0].getBoundingBox(),s=i.vec3.copy([],n[0]),r=i.vec3.copy([],n[1]);for(let e=1;e<t.length;e++){const n=t[e].getBoundingBox(),o=i.vec3.copy([],n[0]),h=i.vec3.copy([],n[1]);o[0]<s[0]&&(s[0]=o[0]),o[1]<s[1]&&(s[1]=o[1]),o[2]<s[2]&&(s[2]=o[2]),h[0]>r[0]&&(r[0]=h[0]),h[1]>r[1]&&(r[1]=h[1]),h[2]>r[2]&&(r[2]=h[2])}return{min:s,max:r}}zt(t,e){const n=this.gltfScenes[t];if(!n)return;const r=this.layer.st()[t];r.Ie();const o=r.isAnimated();if(o&&r.gltfPack&&this.Ce(r)&&this.isInFrustum(r)&&!e){const t=r.getCurrentAnimation(),e=r.isLooped(),i=r.getAnimationSpeed();(e||!e&&r.gltfPack.isFirstLoop(A,i,t))&&r.gltfPack.updateAnimation(A,e,i,t)}const h=n.modelMeshes,a=r.getModelMatrix();i.mat4.multiply(a,a,D);const u=this.layer.getMap(),c=[],l=[];h.forEach((t=>{j[0]=j[1]=j[2]=1;const e=r.getSymbol(),n=e&&e.fixSizeOnZoom;if(s.Util.isNumber(n))if(n>=0){let t=u.getGLScale()/u.getGLScale(n);t*=r.Ne(),i.vec3.set(j,t,t,t),r.Fe(t)}else{const t=r.Le();i.vec3.set(j,t,t,t),r.Ee(t)}const h=r.de()||[1,1,1];i.vec3.multiply(c,h,j);const f=o?t.properties.geometryResource.nodeMatrix:t.nodeMatrix;if(t instanceof i.reshader.InstancedMesh){i.mat4.scale(l,a,c);const e=i.mat4.multiply(t.positionMatrix,a,f);t.positionMatrix=e}else{i.mat4.scale(l,a,c);const e=i.mat4.multiply(t.localTransform,l,f);t.localTransform=e}if(o){t.material.set("skinAnimation",1);const e=t.geometry.properties.morphWeights;e&&this.re(e,t.material)}else t.material.set("skinAnimation",0)})),e||this.Re(r,h)}Re(t,e){const n=this.he(e,t);if(!n)return;const s=this.Me(t.Oe()||[],n,t);e.forEach((e=>{e.localTransform[12]+=s[0],e.localTransform[13]+=s[1],e.localTransform[14]+=s[2],e instanceof i.reshader.InstancedMesh&&this.je(e,t)}))}fe(t,e){const n=this.he(e,t);t.Te=n;const s=i.vec3.subtract(F,n.max,n.min);i.vec3.divide(s,s,t.getScale());const r=Math.max(...s)/this.layer.getMap().getGLScale(t.getZoomOnAdded());t.De(r)}Be(t,e){for(const i in e)t.setUniform(i,e[i]);return t}je(t,e){const i=e.ne();for(const e in i)t.updateInstancedData(e,i[e]);t.updateBoundingBox(),this.regl?t.generateInstancedBuffers(this.regl):(this.ut=this.ut||[],this.ut.push(t)),t.instanceCount=e.getCount()}Ue(t){if(o(t)){this.Ge(t);const e=this.layer.st()[t].getUrl();this.logoutGLTF(e),delete this.gltfScenes[t],this.setToRedraw(),this.kt=!0}}Ge(t){if(!this.gltfScenes[t])return;this.gltfScenes[t].modelMeshes.forEach((t=>{t.dispose()}))}ot(t,e){const i=["webgl","experimental-webgl"];let n=null;for(let s=0;s<i.length;++s){try{n=t.getContext(i[s],e)}catch(t){}if(n)break}return n}Je(t,e,i={}){if(!this.ft)return null;const n=this.layer.getMap(),r=this.canvas.gl&&this.canvas.gl.wrap;if(this.Dt||r){if(!this.rt||0===this.rt.length)return null;const t=this.Gt(),e=s.Util.extend({},this.lt);e.pointSize=this.layer.options.pointSize||1,this.ft.render(t,e,!0),this.Dt=!1}const{meshId:o,pickingId:h,point:a}=this.ft.pick(t,e,i.tolerance||3,{"projViewMatrix":n.projViewMatrix,"pointSize":this.layer.options.pointSize||1},{viewMatrix:n.viewMatrix,projMatrix:n.projMatrix,returnPoint:!0}),u=this.ze(h);return{meshId:o,target:this.layer.st()[u],pickingId:h,point:a,index:h-u}}ze(t){if(!o(t))return null;if(this.layer.st()[t])return t;const e=Object.keys(this.layer.st()).sort().map((t=>Number(t))),i=e.length;let n=0,s=i-1,r=Math.floor((n+s)/2);for(;n<=i-1&&s>=0;){if(n===s)return e[n];if(e[r]<=t&&t<e[r+1])return e[r];t<e[r]?(s=r-1,r=Math.floor((n+s)/2)):e[r+1]<t&&(n=r+1,r=Math.floor((n+s)/2))}return null}Ce(t){return"effectmarker"!==t.getGLTFMarkerType()&&"glowmarker"!==t.getGLTFMarkerType()}isInFrustum(t){const e=this.layer.getMap(),n=t.Te;if(!n)return!0;const s=i.vec2.set(k,n.min,n.max);return!!f(e.projViewMatrix,s)}getRenderMeshesTest(){return this.Gt()}isMarkerTransparent(t){return t.se()}getMarkerMeshes(t){const e=t.yt();return this.gltfScenes[e].modelMeshes}getMarkerFitSizeScale(t){return t.de()}getMarkerFitTranslate(t){return t.Oe()}getFBORayPicking(){return this.ft}getShaderList(){return this.it}}function J(t,e){var i,n,s;if(X(t)){var r,o=t.stops&&"object"==typeof t.stops[0][0],h=o||void 0!==t.property,a=o||!h,u=t.type||e||"exponential";if("exponential"===u)r=q;else if("interval"===u)r=V;else if("categorical"===u)r=z;else{if("identity"!==u)throw new Error('Unknown function type "'+u+'"');r=$}if(o){var c={},l=[];for(let e=0;e<t.stops.length;e++){var f=t.stops[e];void 0===c[f[0].zoom]&&(c[f[0].zoom]={zoom:f[0].zoom,type:t.type,property:t.property,default:t.default,stops:[]}),c[f[0].zoom].stops.push([f[0].value,f[1]])}for(let t in c)l.push([c[t].zoom,J(c[t])]);i=function(e,i){const n=q({stops:l,base:t.base},e)(e,i);return"function"==typeof n?n(e,i):n},n=!1,s=!1}else a?(i=function(e){const i=r(t,e);return"function"==typeof i?i(e):i},n=!0,s=!1):(i=function(e,i){const n=r(t,i?i[t.property]:null);return"function"==typeof n?n(e,i):n},n=!1,s=!0)}else i=function(){return t},n=!0,s=!0;return i.isZoomConstant=s,i.isFeatureConstant=n,i}function z(t,e){for(let i=0;i<t.stops.length;i++)if(e===t.stops[i][0])return t.stops[i][1];return t.default}function V(t,e){for(var i=0;i<t.stops.length&&!(e<t.stops[i][0]);i++);return t.stops[Math.max(i-1,0)][1]}function q(t,e){for(var i=void 0!==t.base?t.base:1,n=0;!(n>=t.stops.length||e<=t.stops[n][0]);)n++;return 0===n?t.stops[n][1]:n===t.stops.length?t.stops[n-1][1]:H(e,i,t.stops[n-1][0],t.stops[n][0],t.stops[n-1][1],t.stops[n][1])}function $(t,e){return i=e,n=t.default,void 0!==i?i:void 0!==n?n:void 0!==s?s:null;var i,n,s}function H(t,e,i,n,s,r){return"function"==typeof s?function(){var o=s.apply(void 0,arguments),h=r.apply(void 0,arguments);return H(t,e,i,n,o,h)}:s.length?function(t,e,i,n,s,r){var o=[];for(let h=0;h<s.length;h++)o[h]=W(t,e,i,n,s[h],r[h]);return o}(t,e,i,n,s,r):W(t,e,i,n,s,r)}function W(t,e,i,n,s,r){var o,h=n-i,a=t-i;return s*(1-(o=1===e?a/h:(Math.pow(e,a)-1)/(Math.pow(e,h)-1)))+r*o}function X(t){return t&&"object"==typeof t&&(t.stops||t.property&&"identity"===t.type)}function K(t){for(const e in t)if(X(t[e]))return!0;return!1}function Z(t){return Q(t,"exponential")}function Y(t,e){if(!t)return null;var i=!1;if(Array.isArray(t)){var n,s=[];for(let r=0;r<t.length;r++)n=Y(t[r],e),n?(s.push(n),i=!0):s.push(t[r]);return i?s:t}var r,o={"__fn_types_loaded":!0},h=[];for(r in t)t.hasOwnProperty(r)&&h.push(r);const a=function(t){Object.defineProperty(o,t,{get:function(){return this["__fn_"+t]||(this["__fn_"+t]=Z(this["_"+t])),this["__fn_"+t].apply(this,e())},set:function(e){this["_"+t]=e},configurable:!0,enumerable:!0})};for(let e=0,n=h.length;e<n;e++)r=h[e],X(t[r])?(i=!0,o["_"+r]=t[r],a(r)):o[r]=t[r];return i?o:t}function Q(t,e){if(!X(t))return function(){return t};let i=!0,n=!0;const s=(t=JSON.parse(JSON.stringify(t))).stops;if(s)for(let t=0;t<s.length;t++)if(X(s[t][1])){const r=Q(s[t][1],e);i=i&&r.isZoomConstant,n=n&&r.isFeatureConstant,s[t]=[s[t][0],r]}const r=J(t,e);return r.isZoomConstant=i&&r.isZoomConstant,r.isFeatureConstant=n&&r.isFeatureConstant,r}const tt=[];class et extends e.Marker{constructor(t,n){const s=e.Util.extend({},n),r=s.symbol;super(t,s),this.options.symbol=r,this.Ve=!1,this.qe=i.mat4.identity([]),this.$e="gltfmarker",this.He=!0,this.We={get translation(){return[0,0,0]},get rotation(){return[0,0,0]},get scale(){return[1,1,1]}},this.Ie()}static parseJSONData(t){const e=et.fromJSON(t);return e.setZoomOnAdded(t.zoomOnAdded),e}static fromJSON(t){return new et(t.coordinates,t.options)}le(){return this.Xe}ye(t){this.Xe=t}Ke(t,e){this._externSymbol=this._externSymbol||{},this._externSymbol[t]=e,"uniforms"===t&&(this.Ze=!0)}setUrl(t){return super.updateSymbol({url:t}),this}setSymbol(t){const e=this.getUrl(),i=this.getShader(),n=this.Ye&&this.Ye.getRenderer();n&&t.url!==e&&n.logoutGLTF(e),super.setSymbol(t);(t.url||"pyramid")!==e&&this.Ye&&(this.be(!1),this.Ye.Qe(this),this.Ye._t(this)),t.shader!==i&&this.Ye&&this.Ye._t(this),this.Ze=!0,this.He=!0}getCenter(){const t=this.getMap();if(!t)return null;const i=a(t,super.getCenter()||this.getCoordinates()),n=this.getTranslation(),s=new e.Point([i[0]+n[0],i[1]+n[1]]);return t.pointAtResToCoord(s,t.getGLRes())}getUrl(){const t=this._getInternalSymbol();return t&&t.url||"pyramid"}addTo(t){if(this.Ye)throw new Error("GLTFMarker cannot be added to two or more layers at the same time.");return t.addGeometry(this),this}onAdd(){const t=this.getLayer().getMap();if(t&&!o(this.ti)){const e=t.getZoom();this.ti=e}}remove(){this.Ye&&(this.Ye.ei(this),delete this.Xe,delete this.gltfPack,super.remove())}show(){return super.updateSymbol({visible:!0}),this}hide(){super.updateSymbol({visible:!1})}setBloom(t){return super.updateSymbol({bloom:t}),this}isBloom(){const t=this._getInternalSymbol();return t&&t.bloom}setCastShadow(t){return super.updateSymbol({shadow:t}),this}isCastShadow(){const t=this._getInternalSymbol();return t&&t.shadow}outline(){return this.ii=!0,this.He=!0,this}cancelOutline(){return this.ii=!1,this.He=!0,this}isOutline(){return this.ii}isVisible(){const t=this._getInternalSymbol();return!t||!o(t.visible)||t.visible}setCoordinates(t){return super.setCoordinates(t),this.We&&this.Ie(),this.He=!0,this}copy(){const t=this.toJSON(),e=et.fromJSON(t);return e.setZoomOnAdded(this.ti),e}setShader(t){return super.updateSymbol({shader:t}),this}getShader(){const t=this._getInternalSymbol();return t&&t.shader||"pbr"}setUniforms(t){return super.updateSymbol({uniforms:t}),this.Ze=!0,this}getUniforms(){const t=this._getInternalSymbol();return t&&t.uniforms}setUniform(t,e){const i=this.getUniforms()||{};return i[t]=e,super.updateSymbol({uniforms:i}),this.Ze=!0,this}getUniform(t){const e=this._getInternalSymbol();return e&&e.uniforms&&e.uniforms[t]}isAnimated(){const t=this._getInternalSymbol();return t&&t.animation&&this.Xe&&this.Xe.animations}isDashAnimated(){const t=this._getInternalSymbol();return t&&t.uniforms&&t.uniforms.dashEnabled&&t.uniforms.dashAnimate}setAnimation(t){return super.updateSymbol({animation:t}),this}setAnimationloop(t){return super.updateSymbol({loop:t}),this.He=!0,this}isLooped(){const t=this._getInternalSymbol();return t&&t.loop}getAnimationSpeed(){const t=this._getInternalSymbol();return t&&o(t.speed)?t.speed:1}setAnimationSpeed(t){return super.updateSymbol({speed:t}),this}ni(t){const e=this.getMap();return e?a(e,t||this.getCoordinates()):null}setTranslation(t){const e=t||this.We.translation;return super.updateSymbol({translation:e}),this.Ie(),this}getTranslation(){const t=this._getInternalSymbol();return t&&t.translation||this.We.translation}setTRS(t,e,i){const n=t||this.We.translation;return super.updateSymbol({translation:n,rotation:e,scale:i}),this.Ie(),this}si(){const t=this.getTranslation(),e=this.ni();return e?i.vec3.add(this.We.translation,t,e):t}setRotation(t){return super.updateSymbol({rotation:t}),this.Ie(),this}getRotation(){const t=this._getInternalSymbol();return t&&t.rotation||this.We.rotation}setScale(t){const e=t=t||this.We.scale;return super.updateSymbol({scale:e}),this.Ie(),this}getScale(){const t=this._getInternalSymbol();return t&&t.scale||this.We.scale}setFixSizeOnZoom(t){return super.updateSymbol({fixSizeOnZoom:t}),this}getFixSizeOnZoom(){const t=this._getInternalSymbol();return t&&t.fixSizeOnZoom}setAnchorZ(t){return super.updateSymbol({anchorZ:t}),this}getAnchorZ(){const t=this._getInternalSymbol();return t&&t.anchorZ||"bottom"}_setExternSymbol(t){return this.He=!0,super._setExternSymbol(t)}ri(t){return Y(t,(()=>{const t=this.getMap();if(t){return[t.getZoom()]}return null}))}_prepareSymbol(t){super._prepareSymbol(t);const e=this.ri(t);return e&&e.uniforms&&(e.uniforms=this.ri(t.uniforms)),delete this.oi,e}hasFunctionDefinition(){if(o(this.oi))return this.oi;const t=this._getInternalSymbol();return this.oi=K(t)||t&&t.uniforms&&K(t.uniforms),this.oi}onSymbolChanged(){super.onSymbolChanged(),this.We&&this.Ie()}setModelMatrix(t){const e=i.mat4.getTranslation(this.We.translation,t),n=i.mat4.getRotation(this.We.rotation,t),s=i.mat4.getScaling(this.We.scale,t);return this.setTranslation(e),this.setRotation(n),this.setScale(s),this}getModelMatrix(){return this.qe}Ie(){const t=this.getRotation(),e=3===t.length?i.quat.fromEuler(tt,t[0]||0,t[1]||0,t[2]||0):t;this.qe=i.mat4.fromRotationTranslationScale(this.qe,e,this.si(),this.getScale()),this.hi=!0}isDirty(){return this.He}setDirty(t){return this.He=t,this}on(t,e,i){super.on(t,e,i||this),this.Ye&&this.Ye.ai(t)}off(t,e,i){super.off(t,e,i||this),this.Ye&&this.Ye.ui()}ci(){const t=this.toJSON();return t.zoomOnAdded=this.ti,t}toJSON(){const t=JSON.parse(JSON.stringify({coordinates:this.getCoordinates(),options:this.options||{}})),i=this.getId();e.Util.isNil(i)||(t.options.id=i);const n=this.getProperties();n&&(t.options.properties=JSON.parse(JSON.stringify(n)));const s=this.getSymbol();return s&&(t.options.symbol=JSON.parse(JSON.stringify(s))),t}setZoomOnAdded(t){this.ti=t}getZoomOnAdded(){return this.ti}se(){return this.Ct()<1}Ct(){const t=this.getUniforms(),e=this.getShader();return"phong"===e||"wireframe"===e?t&&o(t.opacity)?t.opacity:1:"pbr"===e&&t&&o(t.polygonOpacity)?t.polygonOpacity:1}be(t){this.Ve=t}isLoaded(){return this.Ve}getGLTFMarkerType(){return this.$e}li(t){this.fi=t}yt(){return this.fi}getCount(){return 1}me(t){this.di=t}de(){return this.di}pe(t){this.mi=t}Oe(){return this.mi}getContainerExtent(){const t=this.getLayer();if(!t)throw Error("marker has not be added to layer");return t.oe(this.fi)}getGLTFAsset(){return this.Xe&&this.Xe.asset}openInfoWindow(){this.Xe?super.openInfoWindow():this.once("load",(()=>{super.openInfoWindow()}))}getAnimations(){if(!this.Xe)return null;const t=this.Xe.animations;return t?t.map(((t,e)=>t.name||e)):null}getCurrentAnimation(){const t=this._getInternalSymbol();return t&&t.animationName}setCurrentAnimation(t){this.updateSymbol({animationName:t})}Fe(t){this.pi=t}Le(){return this.pi||1}Ee(t){this.gi=t}Ne(){return this.gi||1}De(t){this._i=t}Ae(){return this._i}$t(){return this.hi}Ht(){this.hi=!1}ue(){return this.Ze}Yt(){this.Ze=!1}setAnimationTimeframe(t){this.gltfPack.updateAnimation(t,this.isLooped(),this.getAnimationSpeed())}Pe(){return this.options.fitSize||100}}et.mergeOptions({symbol:null}),et.registerJSONType("GLTFMarker");
/*!
          Feature Filter by

          (c) mapbox 2016 and maptalks 2018
          www.mapbox.com | www.maptalks.org
          License: MIT, header required.
      */
const it=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function nt(t){return new Function("f",`var p = (f && f.properties || {}); return ${st(t)}`)}function st(t){if(!t)return"true";const e=t[0];if(t.length<=1)return"any"===e?"false":"true";return`(${"=="===e?ot(t[1],t[2],"===",!1):"!="===e?ot(t[1],t[2],"!==",!1):"<"===e||">"===e||"<="===e||">="===e?ot(t[1],t[2],e,!0):"any"===e?ht(t.slice(1),"||"):"all"===e?ht(t.slice(1),"&&"):"none"===e?ct(ht(t.slice(1),"||")):"in"===e?at(t[1],t.slice(2)):"!in"===e?ct(at(t[1],t.slice(2))):"has"===e?ut(t[1]):"!has"===e?ct(ut(t[1])):"true"})`}function rt(t){return"$"===t[0]?"f."+t.substring(1):"p["+JSON.stringify(t)+"]"}function ot(t,e,i,n){const s=rt(t),r="$type"===t?it.indexOf(e):JSON.stringify(e);return(n?`typeof ${s}=== typeof ${r}&&`:"")+s+i+r}function ht(t,e){return t.map(st).join(e)}function at(t,e){"$type"===t&&(e=e.map((t=>it.indexOf(t))));const i=JSON.stringify(e.sort(lt)),n=rt(t);return e.length<=200?`${i}.indexOf(${n}) !== -1`:`function(v, a, i, j) {\n        while (i <= j) { var m = (i + j) >> 1;\n            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;\n        }\n    return false; }(${n}, ${i},0,${e.length-1})`}function ut(t){return"$id"===t?'"id" in f':`${JSON.stringify(t)} in p`}function ct(t){return`!(${t})`}function lt(t,e){return t<e?-1:t>e?1:0}function ft(t){if(!Array.isArray(t))return ft([t]);const e=[];for(let i=0;i<t.length;i++){let n;n=!0===t[i].filter?function(){return!0}:nt(t[i].filter),e.push(dt({},t[i],{filter:n}))}return e}function dt(t){for(let e=1;e<arguments.length;e++){const i=arguments[e];for(const e in i)t[e]=i[e]}return t}const mt=/\{ *([\w_]+) *\}/g;class pt extends et{constructor(t,e){super(t,e),this.$e="effectmarker"}static fromJSON(t){return new pt(t.coordinates,t.options)}isAnimated(){const t=this._getInternalSymbol();return t&&t.animation}setTexture(t){const e=this.getLayer()&&this.getLayer().getRenderer();if(e){const i=this.getTextureUrl();e.yi(i),e.vi(t)}return super.updateSymbol({textureUrl:t}),this}bi(t){const e=this.getTextureUrl(),i=this.getLayer()&&this.getLayer().getRenderer();if(i){let n=e;const s=this.wi();if(s){const i=this.isLooped(),r=this.getAnimationSpeed()||1,o=i?Math.floor(.01*t*r)%s.length:Math.floor(.01*t);n=e.replace(mt,s[o]),this.setUniform("width",1),this.setUniform("height",1),this.setUniform("uvOffset",[0,0])}return i.S(n,this.yt())}return null}wi(){const t=this._getInternalSymbol();return t&&t.textureNames}getTextureUrl(){const t=this._getInternalSymbol();return t&&t.textureUrl||"default"}getUrl(){return"plane"}getShader(){return"effect"}setTransparent(t){return this.options.symbol.transparent=t,this}isTransparent(){return this.options.symbol.transparent}updateUV(t){const e=this.isLooped(),i=this.getAnimationSpeed()||1,n=this.getUniforms()||{},s=n.width||1,r=n.height||1;let o;const h=this.getEffectType();"uv"===h?o=e?.01*t*i%(s*r):.01*t:"sequence"===h&&(o=e?Math.floor(.01*t*i)%(s*r):Math.floor(.01*t));const a=Number(o%s),u=Math.floor(o/s),c=this.bi(t);this._getSymbol()?(this.setUniform("uvOffset",[a,u]),this.setUniform("width",s),this.setUniform("height",r),this.setUniform("texture",c)):this.Ke("uniforms",{uvOffset:[a,u],width:s,height:r,texture:c})}_setExternSymbol(t){super._setExternSymbol(t);const e=this.getLayer()&&this.getLayer().getRenderer();if(e){const t=this.getTextureUrl();e.vi(t)}}getEffectType(){const t=this._getInternalSymbol();return t&&t.effect||"uv"}setEffectType(t){return this._getInternalSymbol().effect=t,this}remove(){const t=this.getLayer()&&this.getLayer().getRenderer();if(t){const e=this.getTextureUrl();t.yi(e)}super.remove()}}const gt=["Point","Polygon","LineString","MultiPoint","MultiPolygon","MultiLineString","GeometryCollection","Feature","FeatureCollection"].reduce(((t,e)=>(t[e]=!0,t)),{}),_t={toGeometry:function(t,i){if(e.Util.isString(t)&&(t=e.Util.parseJSON(t)),Array.isArray(t)){const n=[];for(let s=0,r=t.length;s<r;s++){const r=_t.xi(t[s],i);Array.isArray(r)?e.Util.pushIn(n,r):n.push(r)}return n}return _t.xi(t,i)},xi:function(t,i){if(!t||e.Util.isNil(t.type))return null;const n=t.type;if("Feature"===n){const e=t.geometry,n=_t.xi(e,i);return n?(n.setId(t.id),n.setProperties(t.properties),n):null}if("FeatureCollection"===n){const e=t.features;if(!e)return null;return _t.toGeometry(e,i)}if("Point"===n)return function(t,e){if("EffectLayer"===e)return new pt(t);return new et(t)}(t.coordinates,i);if("GeometryCollection"===n){const e=t.geometries,n=[],s=e.length;for(let t=0;t<s;t++)n.push(_t.xi(e[t],i));return n}throw new Error("geometry's type is invalid, only support type of Point")},isGeoJSON:function(t){return!(!t||"object"!=typeof t)&&(!!t.type&&(!!gt[t.type]&&!(t instanceof e.Geometry)))}};const yt=["mousedown","mouseup","mousemove","click","dbclick","touchstart","touchmove","touchend"],vt=/\{*(\$root)*\}/g;class bt extends s.OverlayLayer{constructor(t,e,i){!e||e instanceof s.Geometry||Array.isArray(e)||gt[e.type]||(i=e,e=null),super(t,null,i),this.pickingId=0,this.Si={},this.ve={},this.Mi={},this.mapEvents="";const n=i&&i.style;this.setStyle(n),e&&this.addGeometry(e)}static registerShader(t,e,i,n){g[t]={name:t,type:e,config:i,uniforms:n}}static removeShader(t){delete g[t]}static getShaders(){const t=[];for(const e in g)t.push({shader:e,uniforms:g[e].uniforms});return t}static getShaderMap(){return g}addGeometry(t,e){let i=_t.isGeoJSON(t)?_t.toGeometry(t,this.getJSONType()):t;i=Array.isArray(i)?i:[i];for(let t=0;t<i.length;t++)if(!this.Oi(i[t]))return void console.error("type of geometry is invalid");super.addGeometry(i,e),Array.isArray(i)&&this.addMarker(i)}addMarker(t){for(let e=0;e<t.length;e++){const i=t[e];i.li(this.pickingId),this.Si[this.pickingId]=i,i.Ye=this,this.ai(i.getListeningEvents());const n=i.getId();n&&(this.Mi[n]=i),i.fire("add",{type:"add",target:i,layer:this}),"groupgltfmarker"===i.getGLTFMarkerType()?this.pickingId+=i.getCount():this.pickingId++,this.Qe(i)}}Qe(t){const e=this.getRenderer();e&&e.loginGLTF(t)}toJSON(t){t||(t={});const e={"type":this.getJSONType(),"id":this.getId(),"options":this.config()};if((r(t.style)||t.style)&&(e.style=this.getStyle()),r(t.geometries)||t.geometries){const t=[],i=this._geoList;for(let e=0;e<i.length;e++){const n=i[e].ci();t.push(n)}e.geometries=t}return e}Oi(t){if(!t.getGLTFMarkerType)return!1;return this.options.marekrTypes.indexOf(t.getGLTFMarkerType())>-1}setStyle(t){return t?(this.options.style=t,this.Ti=JSON.parse(JSON.stringify(t)),this.Ai(),this.fire("setstyle",{target:this,style:this.Ti}),this):(delete this.Ti,delete this.options.style,this)}getStyle(){return this.options.style}updateSymbol(t,e){const i=this.getStyle();this.Pi(t,e,i),this.Pi(t,e,this.Ti),this.Ai(),this.fire("updatesymbol",{target:this,index:t,symbol:e})}Pi(t,e,i){if(!i)return;const n=(i.style?i.style:i)[t].symbol||{};for(const t in e)n[t]=e[t]}Ai(){this.ki(this.Ti);const t=this.Ti.style?this.Ti.style:this.Ti;this.Ii=ft(t);this._geoList.forEach((function(t){this.Ci(t)}),this)}getGLTFUrls(){return Object.keys(this.ve)}ai(t){const e=s.Util.isString(t)?t.split(/\s+/).map((t=>"mouseleave"===t||"mouseenter"===t||"mouseout"===t?"mousemove":t)):t;let i=this.mapEvents;const n=h(e,yt).filter((t=>this.mapEvents.indexOf(t)<0));this.mapEvents+=" "+n.join(" "),this.mapEvents=this.mapEvents.trim();const r=this.mapEvents.replace(" "," dom:");i=i.replace(" "," dom:");const o=this.getMap();o&&(o.off("dom:"+i,this.Ni,this),o.on("dom:"+r,this.Ni,this))}ui(){const t={};let e=this.mapEvents;const i=this._geoList;for(let e=0;e<i.length;e++){const n=i[e].getListeningEvents().map((t=>"mouseleave"===t||"mouseenter"===t||"mouseout"===t?"mousemove":t));for(let e=0;e<n.length;e++)t[n[e]]=1}this.mapEvents=h(Object.keys(t),yt).join(" ");const n=this.mapEvents.replace(" "," dom:");e=e.replace(" "," dom:");const s=this.getMap();s&&(s.off("dom:"+e,this.Ni,this),s.on("dom:"+n,this.Ni,this))}ki(t){s.Util.isString(t.$root)&&t.style.forEach((e=>{const i=e.symbol.url;i&&i.indexOf("{$root}")>-1&&(e.symbol.url=i.replace(vt,t.$root))}))}Ci(t){if(!this.Ii)return!1;for(let e=0,i=this.Ii.length;e<i;e++)if(!0===this.Ii[e].filter({properties:t.getProperties()})){const i=this.Ii[e].symbol,n=i.url;return t.Ke("url",n),this.Qe(t),t._setExternSymbol(i),!0}return!1}Fi(t){if(this.Ii)for(let e=0,i=this.Ii.length;e<i;e++)!0===this.Ii[e].filter({properties:t.getProperties()})&&this.Ii[e].outline&&t.outline()}removeGeometry(t){this.ui(),super.removeGeometry(t)}getMapEvents(){return this.mapEvents}ei(t){const e=s.Util.isString(t)?this.Mi[t].yt():t.yt(),i=this.getRenderer();i&&i.Ue(e),delete this.Si[e],delete this.Mi[t]}clear(){return super.clear(),this.Si={},this.Mi={},this}st(){return this.Si}Je(t,e,i){const n=this.getRenderer();return n?n.Je(t,e,i):null}oe(t){const e=this.getRenderer();return e?e.oe(t):null}Ni(t){if(!this.options.markerEvents)return;const e=this.getMap();if(!e)return;this.Li=this.Ei,this.Ri=this.ji,this.Di=this.Bi,this.Ui=this.Gi;const i=t.containerPoint,n=Math.round(i.x),s=Math.round(i.y);if(n<=0||n>=e.width||s<=0||s>=e.height)return this.Ei=null,this.Bi=null,void(this.ji=null);const r=this.Je(n,s);if(!r)return;this.Ei=r.target?r.target.yt():null,this.Bi=r.meshId,this.ji=JSON.stringify(r.point),this.Gi=r.pickingId;const o=t.type.replace("dom:","");if("mousemove"===o){this.Ji().forEach((t=>{t.target.fire(t.type,t)}))}else r.target&&r.target.fire(o,r)}Ji(){const t=[];return o(this.Ei)&&!o(this.Li)?t.push({type:"mouseenter",target:this.Si[this.Ei],meshId:this.Bi,pickingId:this.Gi,point:JSON.parse(this.ji)}):!o(this.Ei)&&o(this.Li)?t.push({type:"mouseout",target:this.Si[this.Li],meshId:this.Di,pickingId:this.Ui,point:JSON.parse(this.Ri)},{type:"mouseleave",target:this.Si[this.Li],meshId:this.Di,pickingId:this.Ui,point:JSON.parse(this.Ri)}):o(this.Ei)&&o(this.Li)&&(this.Ei===this.Li?t.push({type:"mousemove",target:this.Si[this.Ei],meshId:this.Bi,pickingId:this.Gi,point:JSON.parse(this.ji)}):t.push({type:"mouseenter",target:this.Si[this.Ei],meshId:this.Bi,pickingId:this.Gi,point:JSON.parse(this.ji)},{type:"mouseout",target:this.Si[this.Li],meshId:this.Di,pickingId:this.Ui,point:JSON.parse(this.Ri)},{type:"mouseleave",target:this.Si[this.Li],meshId:this.Di,pickingId:this.Ui,point:JSON.parse(this.Ri)})),t}_t(t){const e=this.getRenderer();e&&e._t(t)}outlineBatch(t){const e=this.Ti.style?this.Ti.style:this.Ti;e[t].outline=!0,this.Ii=ft(e);this._geoList.forEach((t=>{this.Fi(t)}))}outlineAll(){this._geoList.forEach((t=>{t.outline()}))}cancelOutline(){if(this.Ti){(this.Ti.style?this.Ti.style:this.Ti).forEach((t=>{delete t.outline}))}this._geoList.forEach((t=>{t.cancelOutline()}))}}bt.mergeOptions({"renderer":"gl","doubleBuffer":!1,"glOptions":null,"markerEvents":!0,"forceRenderOnZooming":!0,"forceRenderOnMoving":!0,"forceRenderOnRotating":!0});class wt extends bt{static initDefaultShader(){const t=function(){const t={positionAttribute:"POSITION",normalAttribute:"NORMAL",extraCommandProps:{blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},e=new i.reshader.PhongMaterial;return{shader:t,material:e}}();wt.registerShader("phong","PhongShader",t.shader,t.material.getUniforms());const e=function(){const t={positionAttribute:"POSITION",normalAttribute:"NORMAL",extraCommandProps:{cull:{enable:!1,face:"back"},frontFace:"cw",blend:{enable:!1,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},e=new i.reshader.WireFrameMaterial;return{shader:t,material:e}}();wt.registerShader("wireframe","WireframeShader",e.shader,e.material.getUniforms());const n=function(){const t={positionAttribute:"POSITION",normalAttribute:"NORMAL",tangentAttribute:"TANGENT",colorAttribute:"COLOR_0",uv0Attribute:"TEXCOORD_0",uv1Attribute:"TEXCOORD_1",extraCommandProps:{cull:{enable:!0},frontFace:"ccw",blend:{enable:(t,e)=>!!e.meshConfig.transparent,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"},equation:"add"}}},e=new i.reshader.pbr.StandardMaterial({});return{shader:t,material:e}}();wt.registerShader("pbr","pbr.StandardShader",n.shader,n.material.getUniforms()),wt.registerShader("depth","pbr.StandardDepthShader",n.shader,n.material.getUniforms());const s=function(){const t={positionAttribute:"POSITION",color0Attribute:"COLOR_0",extraCommandProps:{blend:{enable:!1,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},e=new i.reshader.Material;return{shader:t,material:e}}();wt.registerShader("pointline","PointLineShader",s.shader,s.material.getUniforms())}static fromJSON(t){if(!t||"GLTFLayer"!==t.type)return null;const e=new wt(t.id,t.options),i=t.geometries,n=[];for(let t=0;t<i.length;t++){const e=et.parseJSONData(i[t]);e&&n.push(e)}return e.addGeometry(n),t.style&&e.setStyle(t.style),e}onAdd(){const t=this.getMap();t.on(this.mapEvents,this.Ni,this);this._geoList.forEach((e=>{o(e.getZoomOnAdded())||e.setZoomOnAdded(t.getZoom())})),super.onAdd()}onRemove(){super.onRemove(),this.clear()}remove(){const t=this.getMap();if(!t)return;const e=this.mapEvents.replace(" "," dom:");t.off("dom:"+e,this.Ni,this),super.remove()}identify(t,e){const i=this.getMap();if(!i)return[];const n=i.coordinateToContainerPoint(new s.Coordinate(t));return this.identifyAtPoint(n,e)}identifyAtPoint(t,e){const i=this.getMap();if(!i)return[];const n=i.getDevicePixelRatio(),s=t.x*n,r=t.y*n,o=this.Je(s,r,e);return o&&o.target?[{data:o.target,point:o.point}]:[]}zi(){const t=this.getRenderer();t?this.Vi(t.gltfScenes):this.on("renderercreate",(t=>{this.Vi(t.renderer.gltfScenes)}))}Vi(t){this.pickingId=0;for(const e in this.Si){const i=this.Si[e],n=t[e],s=i.yt();delete this.Si[s],delete t[s],i.li(this.pickingId),this.Si[this.pickingId]=i,t[this.pickingId]=n;const r=i.getCount();this.pickingId+=r}}}wt.initDefaultShader(),wt.mergeOptions({marekrTypes:["gltfmarker","groupgltfmarker"],pointSize:1}),wt.registerJSONType("GLTFLayer"),wt.registerRenderer("gl",G);const xt=[1,1,1,1],St=[],Mt=[];class Ot extends et{constructor(t,e){super(null,e),this.qi=t,this.$i=[],this.$e="groupgltfmarker"}static fromJSON(t){return new Ot(t.data,t.options)}setCoordinates(t){return Array.isArray(t[0])?this.Hi=t.map((t=>new e.Coordinate(t))):this.Hi=t,this.updateAllData("coordinates",this.Hi),this.He=!0,this}getCoordinates(t){if(t&&this.qi&&this.qi.length){const e=t.index;return this.qi[e].coordinates}return null}addData(t){this.qi.push(t);const e=this.getLayer();return e&&e.zi(),this.He=!0,this}removeData(t){return this.qi.splice(t,1),this.ie&&this.$i.splice(t,1),this.He=!0,this}getData(t){return this.qi[t]}updateData(t,e,i){return this.qi[t][e]=i,this.He=!0,this}updateAllData(t,e){for(let i=0;i<this.qi.length;i++)this.updateData(i,t,e[i]);return this}ie(){if(this.qi){this.$i=this.$i||[];for(let t=0;t<this.qi.length;t++){const e=this.Wi(t);this.$i[t]=e}}}Wi(t){const e=this.qi[t],n=this.ni(e.coordinates),s=i.vec3.add(St,e.translation||this.We.translation,n||this.We.translation),r=e.rotation||this.We.rotation,o=e.scale||this.We.scale,h=i.quat.fromEuler(Mt,r[0]||0,r[1]||0,r[2]||0);return i.mat4.fromRotationTranslationScale(this.$i[t]||[],h,s,o)}Ie(){super.Ie(),this.ie()}Xi(){this.Ki&&this.Ki.instance_vectorA.length/4===this.$i.length||(this.Ki={"instance_vectorA":[],"instance_vectorB":[],"instance_vectorC":[],"instance_vectorD":[],"instance_color":[],"aPickingId":[]});for(let t=0;t<this.$i.length;t++){const e=this.$i[t];this.Zi("instance_vectorA",t,0,4,e),this.Zi("instance_vectorB",t,1,4,e),this.Zi("instance_vectorC",t,2,4,e),this.Zi("instance_vectorD",t,3,4,e),this.Zi("instance_color",t,0,1,this.qi[t].color||xt),this.Ki.aPickingId[t]=this.yt()+t}return this.Ki}Zi(t,e,i,n,s){this.Ki[t][4*e]=s[i*n],this.Ki[t][4*e+1]=s[i*n+1],this.Ki[t][4*e+2]=s[i*n+2],this.Ki[t][4*e+3]=s[i*n+3]}ne(t){return this.He?this.Xi(t):this.Ki}getCount(){return this.qi.length}toJSON(){const t=JSON.parse(JSON.stringify({data:this.qi,options:this.options})),e=this.getProperties();return t.options&&(t.options.properties=e),t}getIndexByPickingId(t){return t-this.yt()}}const Tt=new i.reshader.Texture2D({url:void 0,mag:"linear"});class At extends G{constructor(t){super(t),this._textureMap={}}S(t){return this.regl&&this._textureMap[t]?this._textureMap[t].texture.getREGLTexture(this.regl):Tt}vi(t){if(this._textureMap[t])this._textureMap[t].count++;else{this.Yi=this.Yi||new i.reshader.ResourceLoader;const e="default"===t?void 0:t,n=new i.reshader.Texture2D({url:e,mag:"linear"},this.Yi);n.once("complete",(()=>{this.setToRedraw()}),this),this._textureMap[t]={count:1,texture:n}}}yi(t){this._textureMap[t]&&(this._textureMap[t].count--,this._textureMap[t].count<1&&(this._textureMap[t].texture.dispose(),delete this._textureMap[t]))}}class Pt extends bt{static initDefaultShader(){const t=function(){const t={vert:"\n        attribute vec3 aPosition;\n        attribute vec2 aTexCoord;\n        uniform mat4 projViewMatrix;\n        uniform mat4 modelMatrix;\n        uniform vec2 uvOffset;\n        uniform float width;\n        uniform float height;\n        varying vec2 vTexCoords;\n        void main()\n        {\n            gl_Position = projViewMatrix * modelMatrix * vec4(aPosition, 1.0);\n            vTexCoords = (uvOffset + aTexCoord) * vec2(1.0 / width, 1.0 / height);\n        }\n    ",frag:"\n        precision mediump float;\n        uniform sampler2D texture;\n\n        varying vec2 vTexCoords;\n        void main() {\n            vec4 color = texture2D(texture, vTexCoords);\n            gl_FragColor = vec4(color.rgb, color.a) * color.a;\n        }\n    ",positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}},e=new i.reshader.Material;return{shader:t,material:e}}();Pt.registerShader("effect","MeshShader",t.shader,t.material.getUniforms())}onAddGeometry(t){super.onAddGeometry(t);const e=t.getTextureUrl(),i=this.getRenderer();i?i.vi(e):this.on("renderercreate",(t=>{t.renderer.vi(e)}))}remove(){const t=this.getRenderer();t&&this._geoList.forEach((e=>{const i=e.getTextureUrl();t.yi(i)})),super.remove()}clear(){const t=this.getRenderer();t&&this._geoList.forEach((e=>{const i=e.getTextureUrl();t.yi(i)})),super.clear()}getTextureMapTest(){const t=this.getRenderer();return t?t._textureMap:null}}Pt.initDefaultShader(),Pt.mergeOptions({marekrTypes:["effectmarker"]}),Pt.registerJSONType("EffectLayer"),Pt.registerRenderer("gl",At);class kt extends et{constructor(t,e){super(t,e),this.$e="glowmarker"}static fromJSON(t){return new kt(t.coordinates,t.options)}getUrl(){return"plane"}setSpeed(t){this.setUniform("speed",t)}getSpeed(){return this._getInternalSymbol().uniforms.speed}getShader(){return"glowmarker"}isAnimated(){const t=this._getInternalSymbol();return t&&t.animation}ae(){const t=this._getInternalSymbol();t.uniforms.time=t.uniforms.time||0,t.uniforms.time+=.01}}kt.mergeOptions({visible:!0});class It extends bt{static initDefaultShader(){const t=function(){const t={vert:"\n        #ifdef GL_ES\n            precision highp float;\n        #endif\n        attribute vec3 aPosition;\n        uniform mat4 projViewModelMatrix;\n        uniform mat4 modelMatrix;\n        varying vec3 v_FragPos;\n        varying vec3 v_center;\n        void main(){\n            gl_Position=projViewModelMatrix*vec4(aPosition,1.);\n            vec4 worldPos = modelMatrix * vec4(aPosition, 1.0);\n            v_FragPos = worldPos.xyz;\n            v_center = (modelMatrix * vec4(0.0, 0.0, 0.0, 1.0)).xyz;\n        }\n    ",frag:"\n        #ifdef GL_ES\n            precision highp float;\n        #endif\n        #define pi 3.14159\n        const float dotsnb = 30.0; // Number of dots\n\n        varying vec3 v_FragPos;\n        varying vec3 v_center;\n        uniform float time;\n        uniform float radius;\n        uniform vec3 color;\n        uniform float speed;\n        vec3 hsb2rgb(in vec3 c)\n        {\n            vec3 rgb = clamp(abs(mod(c.x*6.0+vec3(0.0,4.0,2.0),6.0)-3.0)-1.0,0.0,1.0 );\n            rgb = rgb*rgb*(4.0-2.0*rgb);\n            return c.z * mix( vec3(1.0), rgb, c.y);\n        }\n\n        void main()\n        {\n            float r = length(v_FragPos - v_center);\n            r = r*2.-1.;\n            if(r>radius) {\n                gl_FragColor = vec4(1.0,1.0,1.0, 0.0);\n            } else {\n                //vec3 color = hsb2rgb(vec3(fract(time*.1),.7,.4));\n                vec3 color = color;\n                float s = abs(sin(pow(r+5.0, 1.5)-time*speed+sin(r*0.9))*sin(r+.99));\n                color *= (abs(1./(s*10.8))-.01);\n                gl_FragColor = vec4(color, (color.x + color.y + color.z) / 1.0);\n            }\n        }\n    ",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return i.mat4.multiply([],e.projViewMatrix,e.modelMatrix)}}],positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one",dstAlpha:1},equation:{rgb:"add",alpha:"add"},color:[0,0,0,0]}}},e=new i.reshader.Material;return{shader:t,material:e}}();It.registerShader("glowmarker","MeshShader",t.shader,t.material.getUniforms())}}It.initDefaultShader(),It.mergeOptions({marekrTypes:["glowmarker"]}),It.registerJSONType("GlowMarkerLayer"),It.registerRenderer("gl",G);const Ct={url:"plane",animation:!0,loop:!0,rotation:[0,0,0],translation:[0,0,30],scale:[1,1,30]},Nt={width:1,height:1,modelHeight:60,startOpacity:0,endOpacity:1};class Ft extends bt{static initDefaultShader(){const t=function(){const t={vert:"\n        attribute vec3 aPosition;\n        attribute vec2 aTexCoord;\n        uniform mat4 projViewMatrix;\n        uniform mat4 modelMatrix;\n        uniform vec2 uvOffset;\n        uniform float width;\n        uniform float height;\n        varying vec2 vTexCoords;\n        varying float vHeight;\n        void main()\n        {\n            vec4 worldPosition = modelMatrix * vec4(aPosition, 1.0);\n            gl_Position = projViewMatrix * worldPosition;\n            vHeight = worldPosition.z;\n            vTexCoords = (uvOffset + aTexCoord) * vec2(1.0 / width, 1.0 / height);\n        }\n    ",frag:"\n        precision mediump float;\n        uniform sampler2D texture;\n        uniform float modelHeight;\n        uniform float startOpacity;\n        uniform float endOpacity;\n        varying float vHeight;\n        varying vec2 vTexCoords;\n        void main() {\n            vec4 color = texture2D(texture, vTexCoords);\n            float opacity = (endOpacity - startOpacity) * (1.0 - vHeight / modelHeight);\n            gl_FragColor = vec4(color.rgb, color.a) * color.a * opacity;\n        }\n    ",positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}},e=new i.reshader.Material;return{shader:t,material:e}}();Ft.registerShader("effectline","MeshShader",t.shader)}}Ft.initDefaultShader(),Ft.mergeOptions({marekrTypes:["effectmarker"]}),Ft.registerJSONType("EffectLineLayer"),Ft.registerRenderer("gl",At);const Lt={offsetX:0,offsetY:0,uReflectivity:.8,opacity:.9,color:[.9,0,0,1]};class Et extends bt{static initDefaultShader(){const t=function(){const t={vert:"\n        attribute vec3 aPosition;\n        attribute vec2 aTexCoord;\n        attribute vec3 aNormal;\n        uniform mat4 projViewMatrix;\n        uniform mat4 modelMatrix;\n        uniform mat4 normalMatrix;\n        uniform float offsetX;\n        uniform float offsetY;\n        varying vec2 uv;\n        void main()\n        {\n            gl_Position = projViewMatrix * modelMatrix * vec4(aPosition, 1.0);\n            uv = vec2(aTexCoord.x + offsetX, aTexCoord.y + offsetY);\n        }\n    ",frag:"\n        precision mediump float;\n        uniform sampler2D effectTexture;\n        uniform vec3 uCameraPosition;\n        uniform mat4 viewMatrix;\n        uniform float uReflectivity;\n        uniform vec4 color;\n        uniform float opacity;\n\n        varying vec2 uv;\n\n        vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {\n            return normalize((vec4(dir, 0.0) * matrix).xyz);\n        }\n\n        const float GAMMA_FACTOR = 2.0;\n        vec4 GammaToLinear(in vec4 value, in float gammaFactor) {\n            return vec4(pow(value.xyz, vec3(gammaFactor)), value.w);\n        }\n\n        vec4 mixTexelToLinear(vec4 value) {\n            return GammaToLinear(value, float(GAMMA_FACTOR));\n        }\n\n        void main() {\n            vec4 texColor = texture2D(effectTexture, uv);\n            if (color.a == 0.0) {\n                discard;\n            }\n            vec4 mixColor = mixTexelToLinear(color);\n            texColor.rgb += mixColor.xyz * uReflectivity;\n            texColor.a*= opacity;\n            gl_FragColor = texColor;\n        }\n    ",uniforms:[{name:"normalMatrix",type:"function",fn:function(t,e){const n=[];return i.mat4.invert(n,e.modelMatrix),i.mat4.transpose(n,n),n}}],positionAttribute:"POSITION",extraCommandProps:{depth:{enable:!0,mask:!1},blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}},e=new i.reshader.Material;return{shader:t,material:e}}();Et.registerShader("effectring","MeshShader",t.shader)}}Et.initDefaultShader(),Et.mergeOptions({marekrTypes:["effectring"]}),Et.registerJSONType("EffectRingLayer"),Et.registerRenderer("gl",G);const Rt={animation:!0,loop:!0,url:"plane",effect:"sequence",speed:1,scale:[1,1,1],rotation:[90,0,0]},jt={width:9,height:5};t.AEMarker=class extends pt{constructor(t,i){super(t,i);const n=e.Util.extend({},Rt,this.options.symbol);this.setSymbol(n);const s=e.Util.extend({},jt,this.options.symbol.uniforms);this.setUniforms(s)}},t.EffectLayer=Pt,t.EffectLine=class extends pt{constructor(t,i){super(t,i);const n=e.Util.extend({},Ct,this.options.symbol);this.setSymbol(n);const s=e.Util.extend({},Nt,this.options.symbol.uniforms);this.setUniforms(s),this.setShader("effectline"),this.$e="effectmarker"}getEffectType(){return"sequence"}setTexture(t){return this.setUniform("texture",t),this}setHeight(t){return this.setUniform("modelHeight",t),this}setStartOpacity(t){return this.setUniform("startOpacity",t),this}setEndOpacity(t){return this.setUniform("endOpacity",t),this}},t.EffectLineLayer=Ft,t.EffectMarker=pt,t.EffectRing=class extends et{constructor(t,i){super(t,i);const n=e.Util.extend({},Lt,this.options.symbol.uniforms);this.setUniforms(n),this.setShader("effectring"),this.$e="effectring"}},t.EffectRingLayer=Et,t.GLTFLayer=wt,t.GLTFMarker=et,t.GlowMarker=kt,t.GlowMarkerLayer=It,t.GroupGLTFMarker=Ot,Object.defineProperty(t,"t",{value:!0})})),r.Map.VERSION,o.GroupGLLayer.VERSION,"undefined"!=typeof console&&console.log("@maptalks/gltf-layer v0.30.1")}));
